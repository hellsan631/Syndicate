!function(){"use strict";angular.module("app",["ngAnimate","ngTouch","ui.router","ui.materialize","LocalForageModule","angular-redactor","angularMoment","permission","lbServices","ls.LiveSet","ls.ChangeStream","random-words","ang-drag-drop"])}();
!function(){"use strict";function LoginController($rootScope,$state,$localForage,LoopBackAuth,Member){function submitLogin(){loginUser(_this.login).then(function(){$state.go("forum")})}function loginUser(loginFields){return Member.login(loginFields).$promise.then(function(response){return response.user.username!==loginFields.username?(swal("Invalid ID","Your ID is not valid","error"),Member.logout()):response.user.banned?(swal("Banned","You have been banned from this forum","error"),Member.logout()):(LoopBackAuth.currentUserId=response.userId,LoopBackAuth.accessTokenId=response.id,LoopBackAuth.save(),$rootScope.currentUser=response.user,$localForage.setItem("currentUser",response.user))})}var _this=this;this.login={},this.submitLogin=submitLogin}angular.module("app").controller("LoginController",LoginController),LoginController.$inject=["$rootScope","$state","$localForage","LoopBackAuth","Member"]}();
!function(){"use strict";function TopicController($scope,$rootScope,$timeout,$q,$stateParams,$localForage,createChangeStream,Topic,Post){function syncPosts(id){var src=new EventSource("/api/Topics/change-stream?_format=event-stream"),changes=createChangeStream(src);getTopic(id),changes.on("data",function(msg){getTopic(id)}),$scope.$on("$destroy",function(){src.close()})}function newPostModal(quote,username){quote&&(_this.newPost.content="<p><blockquote>@"+username+"<br/>"+quote+"</blockquote></p><br/>"),_postModal.openModal()}function createNewPost(){return _this.newPost.content&&0!==_this.newPost.content.length?void createPost(_this.topic).then(function(){_postModal.closeModal(),_this.newPost={}}):errorMessage("No Post Content","You need to enter in some content to make a topic")}function errorMessage(title,text){return swal(title,text,"error"),$q(function(){return null})}function createPost(topic){return _this.newPost.topicId=topic.id,_this.newPost.memberId=$rootScope.currentUser.id,Post.create(_this.newPost).$promise}function getTopic(id){Topic.findById({id:id,filter:{include:{posts:"member"}}}).$promise.then(filterNewResults)}function filterNewResults(results){_this.topic=results,_this.initialized||$timeout(function(){_this.initialized=!0},100)}var _this=this,_postModal=$("#NewPost");_this.initialized=!1,_this.newPost={},_this.newPostModal=newPostModal,_this.createNewPost=createNewPost,syncPosts($stateParams.id),$localForage.setItem($stateParams.id,!0)}angular.module("app").controller("TopicController",TopicController),TopicController.$inject=["$scope","$rootScope","$timeout","$q","$stateParams","$localForage","createChangeStream","Topic","Post"]}();
!function(){"use strict";function ForumController($scope,$rootScope,$timeout,$q,createChangeStream,Topic,Post){function syncTopics(){var src=new EventSource("/api/Topics/change-stream?_format=event-stream"),changes=createChangeStream(src);getTopics(),changes.on("data",function(msg){$timeout(function(){getTopics()},250)}),$scope.$on("$destroy",function(){src.close()})}function getTopics(){Topic.find({filter:{include:["member","original"]}}).$promise.then(filterNewResults)}function filterNewResults(results){_this.topics=results,_this.initialized||$timeout(function(){_this.initialized=!0},100)}function newTopicModal(){_topicModal.openModal()}function createNewTopic(){return _this.post.content&&0!==_this.post.content.length?(_this.topic.memberId=_this.post.memberId=$rootScope.currentUser.id,void createTopic(_this.topic).then(createPost).then(function(){_topicModal.closeModal(),_this.topic={},_this.post={}})):errorMessage("No Post Content","You need to enter in some content to make a topic")}function errorMessage(title,text){return swal(title,text,"error"),$q(function(){return null})}function createTopic(topic){return Topic.create(topic).$promise}function createPost(topic){return _this.post.originalId=_this.post.topicId=topic.id,Post.create(_this.post).$promise}var _this=this,_topicModal=$("#NewTopic");_this.topics=[],_this.initialized=!1,_this.newTopicModal=newTopicModal,_this.createNewTopic=createNewTopic,syncTopics()}angular.module("app").controller("ForumController",ForumController),ForumController.$inject=["$scope","$rootScope","$timeout","$q","createChangeStream","Topic","Post"]}();
!function(){"use strict";function BlogController($state,$localForage){function clear(){_this.dragged=!1}function onDrop($event,$data){_this.dragged||(_this.dragged=""),_this.dragged+=$data.charAt(0),check()}function check(){var compare=_this.dragged.toLowerCase();"syn"===compare&&$localForage.setItem("syndicated",!0).then(function(){$state.go("login")})}var _this=this;_this.onDrop=onDrop,_this.clear=clear,_this.paragraphs=["The rabbit-hole went straight on like a tunnel for some way, and then dipped suddenly down, so suddenly that Alice had not a moment to think about stopping herself before she found herself falling down what seemed to be a very deep well.".split(" "),'Either the well was very deep, or she fell very slowly, for she had plenty of time as she went down to look about her, and to wonder what was going to happen next. First, she tried to look down and make out what she was coming to, but it was too dark to see anything: then she looked at the sides of the well, and noticed that they were filled with cupboards and book-shelves: here and there she saw maps and pictures hung upon pegs. She took down ajar from one of the shelves as she passed: it was labeled "ORANGE MARMALADE" but to her great disappointment it was empty: she did not like to drop the jar, for fear of killing somebody underneath, so managed to put it into one of the cupboards as she fell past it.'.split(" "),'"Well!" thought Alice to herself "After such a fall as this, I shall think nothing of tumbling down-stairs! How brave theyll all think me at home! Why, I wouldnt say anything about it, even if I fell off the top of the house!" (which was very likely true.)'.split(" "),'Down, down, down. Would the fall never come to an end? "I wonder how many miles Ive fallen by this time?" she said aloud. "I must be getting somewhere near the centre of the earth. Let me see: that would be four thousand miles down, I think-" (for, you see, Alice had learnt several things of this sort in her lessons in the school-room, and though this was not a very good opportunity for showing off her knowledge, as there was no one to listen to her, still it was good practice to say it over) "-- yes thats about the right distance -- but then I wonder what Latitude or Longitude Ive got to?" (Alice had not the slightest idea what Latitude was, or Longitude either, but she thought they were nice grand words to say.)'.split(" "),'Presently she began again. "I wonder if I shall fall fight through the earth! How funny itll seem to come out among the people that walk with their heads downwards! The antipathies, I think-" (she was rather glad there was no one listening, this time, as it didnt sound at all the right word) "-but I shall have to ask them what the name of the country is, you know. Please, Maam, is this New Zealand? Or Australia?" (and she tried to curtsey as she spoke- fancy, curtseying as youre falling through the air! Do you think you could manage it?) "And what an ignorant little girl shell think me for asking! No, itll never do to ask: perhaps I shall see it written up somewhere."'.split(" "),'Down, down, down. There was nothing else to do, so Alice soon began talking again. "Dinahll miss me very much to-night, I should think!" (Dinah was the cat.) "I hope theyll remember her saucer of milk at tea-time. Dinah, my dear! I wish you were down here with me! There are no mice in the air, Im afraid, but you might catch a bat, and thats very like a mouse, you know. But do cats eat bats, I wonder?" And here Alice began to get rather sleepy, and went on saying to herself, in a dreamy son of way, "Do cats eat bats? Do cats eat bats?" and sometimes "Do bats eat cats?" for, you see, as she couldnt answer either question, it didnt much matter which way she put it. She felt that she was dozing off, and had just begun to dream that she was walking hand in hand with Dinah, and was saying to her, very earnestly, "Now, Dinah, tell me the truth: did you ever eat a bat?" when suddenly, thump! thump! down she came upon a heap of sticks and dry leaves, and the fall was over.'.split(" ")]}angular.module("app").controller("BlogController",BlogController),BlogController.$inject=["$state","$localForage"]}();
!function(){"use strict";function AdminController($scope,$rootScope,$timeout,$q,$localForage,LoopBackAuth,createChangeStream,Member,RandomWords){function saveUser(){swal({title:"Are you sure?",text:"Changes you make might prevent a user from logging in!",type:"info",showCancelButton:!0,confirmButtonText:"Save",cancelButtonText:"Cancel",closeOnConfirm:!0,closeOnCancel:!0},confirmSave)}function confirmSave(confirm){if(confirm){var editMember={};editMember.email=_this.editMember.email,editMember.isAdmin=_this.editMember.isAdmin,_this.editMember.password&&_this.editMember.password.length>6&&(editMember.password=_this.editMember.password),Member.prototype$updateAttributes({id:_this.editMember.id},editMember).$promise.then(function(topic){swal("Saved","Successfully saved member","success"),getMembers(),_memberModal.closeModal()})["catch"](function(err){swal("Error","Unable to save member","error"),console.log(err)})}}function clearNewUser(){_this.user={email:"",username:""},password()}function openEditModal(member){var editMember=member;editMember.password="",_this.editMember=editMember,_memberModal.openModal()}function unbanMember(memberId,$event){$event.stopPropagation(),swal({title:"Are you sure?",type:"info",showCancelButton:!0,confirmButtonText:"Un-Ban",cancelButtonText:"Cancel",closeOnConfirm:!0,closeOnCancel:!0},function(confirm){confirm&&confirmUnBan(memberId)})}function confirmUnBan(memberId){Member.prototype$updateAttributes({id:memberId},{banned:!1}).$promise.then(function(topic){swal("Banned Lifted","Successfully unbanned member","success"),getMembers(),_memberModal.closeModal()})["catch"](function(err){swal("Error","Unable to un-ban member","error"),console.log(err)})}function banMember(memberId,$event){$event.stopPropagation(),swal({title:"Are you sure?",text:"This will not remove a users posts/topics. It will only prevent them from logging in.",type:"warning",showCancelButton:!0,confirmButtonText:"Ban",confirmButtonColor:"#ff3B33",cancelButtonText:"Cancel",closeOnConfirm:!0,closeOnCancel:!0},function(confirm){confirm&&confirmBan(memberId)})}function confirmBan(memberId){Member.prototype$updateAttributes({id:memberId},{banned:!0}).$promise.then(function(topic){swal("Banned","Successfully banned member","success"),getMembers(),_memberModal.closeModal()})["catch"](function(err){swal("Error","Unable to ban member","error"),console.log(err)})}function getMembers(){Member.find().$promise.then(function(res){_this.members=res})}function editPassword(){_this.editMember.password=RandomWords.password()}function password(){_this.user.password=RandomWords.password()}function submitNewUser(){verifyUser(_this.user).then(createUser).then(clearForm)["catch"](errorMessage)}function clearForm(res){var deferred=$q.defer();return setTimeout(function(){swal("Success!","Successfully created "+res.id,"success"),deferred.resolve(res)}),deferred.promise}function createUser(user){return Member.create(user).$promise}function verifyUser(user){var deferred=$q.defer();return setTimeout(function(){user.email?deferred.resolve(user):deferred.reject("Users require an email")}),deferred.promise}function errorMessage(title,text){return swal(title,text,"error"),$q(function(){return null})}var _this=this,_memberModal=$("#EditMember");_this.user={password:RandomWords.password()},_this.members=[],_this.password=password,_this.submitNewUser=submitNewUser,_this.getMembers=getMembers,_this.banMember=banMember,_this.openEditModal=openEditModal,_this.editPassword=editPassword,_this.clearNewUser=clearNewUser,_this.saveUser=saveUser,_this.unbanMember=unbanMember,getMembers()}angular.module("app").controller("AdminController",AdminController),AdminController.$inject=["$scope","$rootScope","$timeout","$q","$localForage","LoopBackAuth","createChangeStream","Member","RandomWords"]}();
!function(){"use strict";function TopicItem($state,$localForage,Topic){function controller($scope){$scope.deleteMe=function($event){$event.stopPropagation(),$scope.user.id===$scope.topic.member.id&&swal({title:"Are you sure?",text:"You will not be able to recover this topic. It will be gone forever!",type:"warning",showCancelButton:!0,confirmButtonColor:"#ff3B33",confirmButtonText:"Delete",cancelButtonText:"Cancel",closeOnConfirm:!0,closeOnCancel:!0},function(isConfirm){isConfirm&&Topic.prototype$updateAttributes({id:$scope.topic.id},{deleted:!0,lastUpdated:new Date}).$promise.then(function(topic){swal("Deleted","Successfully deleted topic","success")})["catch"](function(err){swal("Error","Unable to delete topic","error"),console.log(err)})})},$scope.goToTopic=function(){$state.go("topic",{id:$scope.topic.id})},$localForage.getItem($scope.topic.id).then(function(data){data?$scope.seen=!0:$scope.seen=!1})}var directive={restrict:"E",transclude:!0,templateUrl:"app/components/topicItem/topicItem.html",scope:{topic:"=",user:"="},controller:controller};return directive}angular.module("app").directive("topicItem",TopicItem),TopicItem.$inject=["$state","$localForage","Topic"]}();
!function(){"use strict";function Scramble($q,$timeout){function controller($scope){function scramble(newValue,oldValue){!animating&&newValue&&(value=newValue,oldValue||(oldValue=""),animating=newValue,difference=newValue.length-oldValue.length,options=getStringData(newValue),options.step=8,difference>0?deferredShuffle(oldValue.length-1).then(function(){$timeout(function(){animating=!1})}):animating=!1)}function deferredShuffle(start){var deferred=$q.defer();return options.callback=function(){deferred.resolve()},shuffle(start),deferred.promise}function shuffle(start){var i,len=options.letters.length,strCopy=""+value.slice(0);if(start>len)return void options.callback();for(i=Math.max(start,0);len>i;i++)strCopy=i<start+options.step?replaceAt(strCopy,options.letters[i],randomChar(options.types[options.letters[i]])):replaceAt(strCopy,options.letters[i],"");$timeout(function(){$scope.scramble=strCopy}),$timeout(function(){--options.step,shuffle(start+1)},1e3/fps)}function randomChar(type){var pool="";"lowerLetter"===type?pool="abcdefghijklmnopqrstuvwxyz0123456789":"upperLetter"===type?pool="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789":"symbol"===type&&(pool=",.?/\\(^)![]{}*&^%$#'\"");var arr=pool.split("");return arr[Math.floor(Math.random()*arr.length)]}function replaceAt(string,index,character){return string.substr(0,index)+character+string.substr(index+character.length)}function getStringData(str){for(var types=[],letters=[],skip=!1,i=0;i<str.length;i++){var ch=str[i];"<"===ch&&(skip=!0),">"!==ch?skip!==!0&&(" "!==ch?(/[a-z]/.test(ch)?types[i]="lowerLetter":/[A-Z]/.test(ch)?types[i]="upperLetter":types[i]="symbol",letters.push(i)):types[i]="space"):skip=!1}return{types:types,letters:letters,skip:skip}}var options,animating=!1,fps=10,value="",difference=0;$scope.$watch("scramble",scramble)}var directive={restrict:"A",scope:{scramble:"=ngModel"},require:"ngModel",controller:controller};return directive}angular.module("app").directive("scramble",Scramble),Scramble.$inject=["$q","$timeout"]}();
!function(){"use strict";function PostItem(){var directive={restrict:"E",transclude:!0,templateUrl:"app/components/postItem/postItem.html",scope:{post:"=",topic:"="}};return directive}angular.module("app").directive("postItem",PostItem),PostItem.$inject=[]}();
!function(){"use strict";function TopMenu($rootScope,$state,$localForage,Member,LoopBackAuth){function controller($scope){function logout(){Member.logout().$promise.then(function(){return $localForage.removeItem("currentUser")}).then(function(){LoopBackAuth.clearUser(),LoopBackAuth.clearStorage(),$rootScope.currentUser=!1,$state.go("login")})["catch"](removeUser)}function removeUser(){return LoopBackAuth.clearUser(),LoopBackAuth.clearStorage(),$rootScope.currentUser=!1,$localForage.removeItem("currentUser"),$state.go("login")}$scope.logout=logout}var directive={restrict:"E",transclude:!0,templateUrl:"app/components/menu/menu.html",scope:{user:"="},controller:controller};return directive}angular.module("app").directive("topMenu",TopMenu),TopMenu.$inject=["$rootScope","$state","$localForage","Member","LoopBackAuth"]}();
!function(window,angular,undefined){"use strict";var urlBase="/api",authHeader="authorization",module=angular.module("lbServices",["ngResource"]);module.factory("Member",["LoopBackResource","LoopBackAuth","$injector",function(Resource,LoopBackAuth,$injector){var R=Resource(urlBase+"/Members/:id",{id:"@id"},{prototype$__findById__accessTokens:{params:{fk:"@fk"},url:urlBase+"/Members/:id/accessTokens/:fk",method:"GET"},prototype$__destroyById__accessTokens:{params:{fk:"@fk"},url:urlBase+"/Members/:id/accessTokens/:fk",method:"DELETE"},prototype$__updateById__accessTokens:{params:{fk:"@fk"},url:urlBase+"/Members/:id/accessTokens/:fk",method:"PUT"},prototype$__findById__posts:{params:{fk:"@fk"},url:urlBase+"/Members/:id/posts/:fk",method:"GET"},prototype$__destroyById__posts:{params:{fk:"@fk"},url:urlBase+"/Members/:id/posts/:fk",method:"DELETE"},prototype$__updateById__posts:{params:{fk:"@fk"},url:urlBase+"/Members/:id/posts/:fk",method:"PUT"},prototype$__findById__topics:{params:{fk:"@fk"},url:urlBase+"/Members/:id/topics/:fk",method:"GET"},prototype$__destroyById__topics:{params:{fk:"@fk"},url:urlBase+"/Members/:id/topics/:fk",method:"DELETE"},prototype$__updateById__topics:{params:{fk:"@fk"},url:urlBase+"/Members/:id/topics/:fk",method:"PUT"},prototype$__get__accessTokens:{isArray:!0,url:urlBase+"/Members/:id/accessTokens",method:"GET"},prototype$__create__accessTokens:{url:urlBase+"/Members/:id/accessTokens",method:"POST"},prototype$__delete__accessTokens:{url:urlBase+"/Members/:id/accessTokens",method:"DELETE"},prototype$__count__accessTokens:{url:urlBase+"/Members/:id/accessTokens/count",method:"GET"},prototype$__get__posts:{isArray:!0,url:urlBase+"/Members/:id/posts",method:"GET"},prototype$__create__posts:{url:urlBase+"/Members/:id/posts",method:"POST"},prototype$__delete__posts:{url:urlBase+"/Members/:id/posts",method:"DELETE"},prototype$__count__posts:{url:urlBase+"/Members/:id/posts/count",method:"GET"},prototype$__get__topics:{isArray:!0,url:urlBase+"/Members/:id/topics",method:"GET"},prototype$__create__topics:{url:urlBase+"/Members/:id/topics",method:"POST"},prototype$__delete__topics:{url:urlBase+"/Members/:id/topics",method:"DELETE"},prototype$__count__topics:{url:urlBase+"/Members/:id/topics/count",method:"GET"},create:{url:urlBase+"/Members",method:"POST"},createMany:{isArray:!0,url:urlBase+"/Members",method:"POST"},upsert:{url:urlBase+"/Members",method:"PUT"},exists:{url:urlBase+"/Members/:id/exists",method:"GET"},findById:{url:urlBase+"/Members/:id",method:"GET"},find:{isArray:!0,url:urlBase+"/Members",method:"GET"},findOne:{url:urlBase+"/Members/findOne",method:"GET"},updateAll:{url:urlBase+"/Members/update",method:"POST"},deleteById:{url:urlBase+"/Members/:id",method:"DELETE"},count:{url:urlBase+"/Members/count",method:"GET"},prototype$updateAttributes:{url:urlBase+"/Members/:id",method:"PUT"},createChangeStream:{url:urlBase+"/Members/change-stream",method:"POST"},login:{params:{include:"user"},interceptor:{response:function(response){var accessToken=response.data;return LoopBackAuth.setUser(accessToken.id,accessToken.userId,accessToken.user),LoopBackAuth.rememberMe=response.config.params.rememberMe!==!1,LoopBackAuth.save(),response.resource}},url:urlBase+"/Members/login",method:"POST"},logout:{interceptor:{response:function(response){return LoopBackAuth.clearUser(),LoopBackAuth.clearStorage(),response.resource}},url:urlBase+"/Members/logout",method:"POST"},confirm:{url:urlBase+"/Members/confirm",method:"GET"},resetPassword:{url:urlBase+"/Members/reset",method:"POST"},"::get::Post::member":{url:urlBase+"/Posts/:id/member",method:"GET"},"::get::Topic::member":{url:urlBase+"/Topics/:id/member",method:"GET"},getCurrent:{url:urlBase+"/Members/:id",method:"GET",params:{id:function(){var id=LoopBackAuth.currentUserId;return null==id&&(id="__anonymous__"),id}},interceptor:{response:function(response){return LoopBackAuth.currentUserData=response.data,response.resource}},__isGetCurrentUser__:!0}});return R.updateOrCreate=R.upsert,R.update=R.updateAll,R.destroyById=R.deleteById,R.removeById=R.deleteById,R.getCachedCurrent=function(){var data=LoopBackAuth.currentUserData;return data?new R(data):null},R.isAuthenticated=function(){return null!=this.getCurrentId()},R.getCurrentId=function(){return LoopBackAuth.currentUserId},R.modelName="Member",R.posts=function(){var TargetResource=$injector.get("Post"),action=TargetResource["::get::Member::posts"];return action.apply(R,arguments)},R.posts.count=function(){var TargetResource=$injector.get("Post"),action=TargetResource["::count::Member::posts"];return action.apply(R,arguments)},R.posts.create=function(){var TargetResource=$injector.get("Post"),action=TargetResource["::create::Member::posts"];return action.apply(R,arguments)},R.posts.createMany=function(){var TargetResource=$injector.get("Post"),action=TargetResource["::createMany::Member::posts"];return action.apply(R,arguments)},R.posts.destroyAll=function(){var TargetResource=$injector.get("Post"),action=TargetResource["::delete::Member::posts"];return action.apply(R,arguments)},R.posts.destroyById=function(){var TargetResource=$injector.get("Post"),action=TargetResource["::destroyById::Member::posts"];return action.apply(R,arguments)},R.posts.findById=function(){var TargetResource=$injector.get("Post"),action=TargetResource["::findById::Member::posts"];return action.apply(R,arguments)},R.posts.updateById=function(){var TargetResource=$injector.get("Post"),action=TargetResource["::updateById::Member::posts"];return action.apply(R,arguments)},R.topics=function(){var TargetResource=$injector.get("Topic"),action=TargetResource["::get::Member::topics"];return action.apply(R,arguments)},R.topics.count=function(){var TargetResource=$injector.get("Topic"),action=TargetResource["::count::Member::topics"];return action.apply(R,arguments)},R.topics.create=function(){var TargetResource=$injector.get("Topic"),action=TargetResource["::create::Member::topics"];return action.apply(R,arguments)},R.topics.createMany=function(){var TargetResource=$injector.get("Topic"),action=TargetResource["::createMany::Member::topics"];return action.apply(R,arguments)},R.topics.destroyAll=function(){var TargetResource=$injector.get("Topic"),action=TargetResource["::delete::Member::topics"];return action.apply(R,arguments)},R.topics.destroyById=function(){var TargetResource=$injector.get("Topic"),action=TargetResource["::destroyById::Member::topics"];return action.apply(R,arguments)},R.topics.findById=function(){var TargetResource=$injector.get("Topic"),action=TargetResource["::findById::Member::topics"];return action.apply(R,arguments)},R.topics.updateById=function(){var TargetResource=$injector.get("Topic"),action=TargetResource["::updateById::Member::topics"];return action.apply(R,arguments)},R}]),module.factory("Post",["LoopBackResource","LoopBackAuth","$injector",function(Resource,LoopBackAuth,$injector){var R=Resource(urlBase+"/Posts/:id",{id:"@id"},{prototype$__get__member:{url:urlBase+"/Posts/:id/member",method:"GET"},prototype$__get__topic:{url:urlBase+"/Posts/:id/topic",method:"GET"},prototype$__get__original:{url:urlBase+"/Posts/:id/original",method:"GET"},create:{url:urlBase+"/Posts",method:"POST"},createMany:{isArray:!0,url:urlBase+"/Posts",method:"POST"},upsert:{url:urlBase+"/Posts",method:"PUT"},exists:{url:urlBase+"/Posts/:id/exists",method:"GET"},findById:{url:urlBase+"/Posts/:id",method:"GET"},find:{isArray:!0,url:urlBase+"/Posts",method:"GET"},findOne:{url:urlBase+"/Posts/findOne",method:"GET"},updateAll:{url:urlBase+"/Posts/update",method:"POST"},deleteById:{url:urlBase+"/Posts/:id",method:"DELETE"},count:{url:urlBase+"/Posts/count",method:"GET"},prototype$updateAttributes:{url:urlBase+"/Posts/:id",method:"PUT"},createChangeStream:{url:urlBase+"/Posts/change-stream",method:"POST"},"::findById::Member::posts":{params:{fk:"@fk"},url:urlBase+"/Members/:id/posts/:fk",method:"GET"},"::destroyById::Member::posts":{params:{fk:"@fk"},url:urlBase+"/Members/:id/posts/:fk",method:"DELETE"},"::updateById::Member::posts":{params:{fk:"@fk"},url:urlBase+"/Members/:id/posts/:fk",method:"PUT"},"::get::Member::posts":{isArray:!0,url:urlBase+"/Members/:id/posts",method:"GET"},"::create::Member::posts":{url:urlBase+"/Members/:id/posts",method:"POST"},"::createMany::Member::posts":{isArray:!0,url:urlBase+"/Members/:id/posts",method:"POST"},"::delete::Member::posts":{url:urlBase+"/Members/:id/posts",method:"DELETE"},"::count::Member::posts":{url:urlBase+"/Members/:id/posts/count",method:"GET"},"::get::Topic::original":{url:urlBase+"/Topics/:id/original",method:"GET"},"::create::Topic::original":{url:urlBase+"/Topics/:id/original",method:"POST"},"::createMany::Topic::original":{isArray:!0,url:urlBase+"/Topics/:id/original",method:"POST"},"::update::Topic::original":{url:urlBase+"/Topics/:id/original",method:"PUT"},"::destroy::Topic::original":{url:urlBase+"/Topics/:id/original",method:"DELETE"},"::findById::Topic::posts":{params:{fk:"@fk"},url:urlBase+"/Topics/:id/posts/:fk",method:"GET"},"::destroyById::Topic::posts":{params:{fk:"@fk"},url:urlBase+"/Topics/:id/posts/:fk",method:"DELETE"},"::updateById::Topic::posts":{params:{fk:"@fk"},url:urlBase+"/Topics/:id/posts/:fk",method:"PUT"},"::get::Topic::posts":{isArray:!0,url:urlBase+"/Topics/:id/posts",method:"GET"},"::create::Topic::posts":{url:urlBase+"/Topics/:id/posts",method:"POST"},"::createMany::Topic::posts":{isArray:!0,url:urlBase+"/Topics/:id/posts",method:"POST"},"::delete::Topic::posts":{url:urlBase+"/Topics/:id/posts",method:"DELETE"},"::count::Topic::posts":{url:urlBase+"/Topics/:id/posts/count",method:"GET"}});return R.updateOrCreate=R.upsert,R.update=R.updateAll,R.destroyById=R.deleteById,R.removeById=R.deleteById,R.modelName="Post",R.member=function(){var TargetResource=$injector.get("Member"),action=TargetResource["::get::Post::member"];return action.apply(R,arguments)},R.topic=function(){var TargetResource=$injector.get("Topic"),action=TargetResource["::get::Post::topic"];return action.apply(R,arguments)},R.original=function(){var TargetResource=$injector.get("Topic"),action=TargetResource["::get::Post::original"];return action.apply(R,arguments)},R}]),module.factory("Topic",["LoopBackResource","LoopBackAuth","$injector",function(Resource,LoopBackAuth,$injector){var R=Resource(urlBase+"/Topics/:id",{id:"@id"},{prototype$__get__original:{url:urlBase+"/Topics/:id/original",method:"GET"},prototype$__create__original:{url:urlBase+"/Topics/:id/original",method:"POST"},prototype$__update__original:{url:urlBase+"/Topics/:id/original",method:"PUT"},prototype$__destroy__original:{url:urlBase+"/Topics/:id/original",method:"DELETE"},prototype$__get__member:{url:urlBase+"/Topics/:id/member",method:"GET"},prototype$__findById__posts:{params:{fk:"@fk"},url:urlBase+"/Topics/:id/posts/:fk",method:"GET"},prototype$__destroyById__posts:{params:{fk:"@fk"},url:urlBase+"/Topics/:id/posts/:fk",method:"DELETE"},prototype$__updateById__posts:{params:{fk:"@fk"},url:urlBase+"/Topics/:id/posts/:fk",method:"PUT"},prototype$__get__posts:{isArray:!0,url:urlBase+"/Topics/:id/posts",method:"GET"},prototype$__create__posts:{url:urlBase+"/Topics/:id/posts",method:"POST"},prototype$__delete__posts:{url:urlBase+"/Topics/:id/posts",method:"DELETE"},prototype$__count__posts:{url:urlBase+"/Topics/:id/posts/count",method:"GET"},create:{url:urlBase+"/Topics",method:"POST"},createMany:{isArray:!0,url:urlBase+"/Topics",method:"POST"},upsert:{url:urlBase+"/Topics",method:"PUT"},exists:{url:urlBase+"/Topics/:id/exists",method:"GET"},findById:{url:urlBase+"/Topics/:id",method:"GET"},find:{isArray:!0,url:urlBase+"/Topics",method:"GET"},findOne:{url:urlBase+"/Topics/findOne",method:"GET"},updateAll:{url:urlBase+"/Topics/update",method:"POST"},deleteById:{url:urlBase+"/Topics/:id",method:"DELETE"},count:{url:urlBase+"/Topics/count",method:"GET"},prototype$updateAttributes:{url:urlBase+"/Topics/:id",method:"PUT"},createChangeStream:{url:urlBase+"/Topics/change-stream",method:"POST"},"::findById::Member::topics":{params:{fk:"@fk"},url:urlBase+"/Members/:id/topics/:fk",method:"GET"},"::destroyById::Member::topics":{params:{fk:"@fk"},url:urlBase+"/Members/:id/topics/:fk",method:"DELETE"},"::updateById::Member::topics":{params:{fk:"@fk"},url:urlBase+"/Members/:id/topics/:fk",method:"PUT"},"::get::Member::topics":{isArray:!0,url:urlBase+"/Members/:id/topics",method:"GET"},"::create::Member::topics":{url:urlBase+"/Members/:id/topics",method:"POST"},"::createMany::Member::topics":{isArray:!0,url:urlBase+"/Members/:id/topics",method:"POST"},"::delete::Member::topics":{url:urlBase+"/Members/:id/topics",method:"DELETE"},"::count::Member::topics":{url:urlBase+"/Members/:id/topics/count",method:"GET"},"::get::Post::topic":{url:urlBase+"/Posts/:id/topic",method:"GET"},"::get::Post::original":{url:urlBase+"/Posts/:id/original",method:"GET"}});return R.updateOrCreate=R.upsert,R.update=R.updateAll,R.destroyById=R.deleteById,R.removeById=R.deleteById,R.modelName="Topic",R.original=function(){var TargetResource=$injector.get("Post"),action=TargetResource["::get::Topic::original"];return action.apply(R,arguments)},R.original.create=function(){var TargetResource=$injector.get("Post"),action=TargetResource["::create::Topic::original"];return action.apply(R,arguments)},R.original.createMany=function(){var TargetResource=$injector.get("Post"),action=TargetResource["::createMany::Topic::original"];return action.apply(R,arguments)},R.original.destroy=function(){var TargetResource=$injector.get("Post"),action=TargetResource["::destroy::Topic::original"];return action.apply(R,arguments)},R.original.update=function(){var TargetResource=$injector.get("Post"),action=TargetResource["::update::Topic::original"];return action.apply(R,arguments)},R.member=function(){var TargetResource=$injector.get("Member"),action=TargetResource["::get::Topic::member"];return action.apply(R,arguments)},R.posts=function(){var TargetResource=$injector.get("Post"),action=TargetResource["::get::Topic::posts"];return action.apply(R,arguments)},R.posts.count=function(){var TargetResource=$injector.get("Post"),action=TargetResource["::count::Topic::posts"];return action.apply(R,arguments)},R.posts.create=function(){var TargetResource=$injector.get("Post"),action=TargetResource["::create::Topic::posts"];return action.apply(R,arguments)},R.posts.createMany=function(){var TargetResource=$injector.get("Post"),action=TargetResource["::createMany::Topic::posts"];return action.apply(R,arguments)},R.posts.destroyAll=function(){var TargetResource=$injector.get("Post"),action=TargetResource["::delete::Topic::posts"];return action.apply(R,arguments)},R.posts.destroyById=function(){var TargetResource=$injector.get("Post"),action=TargetResource["::destroyById::Topic::posts"];return action.apply(R,arguments)},R.posts.findById=function(){var TargetResource=$injector.get("Post"),action=TargetResource["::findById::Topic::posts"];return action.apply(R,arguments)},R.posts.updateById=function(){var TargetResource=$injector.get("Post"),action=TargetResource["::updateById::Topic::posts"];return action.apply(R,arguments)},R}]),module.factory("LoopBackAuth",function(){function LoopBackAuth(){var self=this;props.forEach(function(name){self[name]=load(name)}),this.rememberMe=undefined,this.currentUserData=null}function save(storage,name,value){var key=propsPrefix+name;null==value&&(value=""),storage[key]=value}function load(name){var key=propsPrefix+name;return localStorage[key]||sessionStorage[key]||null}var props=["accessTokenId","currentUserId"],propsPrefix="$LoopBack$";return LoopBackAuth.prototype.save=function(){var self=this,storage=this.rememberMe?localStorage:sessionStorage;props.forEach(function(name){save(storage,name,self[name])})},LoopBackAuth.prototype.setUser=function(accessTokenId,userId,userData){this.accessTokenId=accessTokenId,this.currentUserId=userId,this.currentUserData=userData},LoopBackAuth.prototype.clearUser=function(){this.accessTokenId=null,this.currentUserId=null,this.currentUserData=null},LoopBackAuth.prototype.clearStorage=function(){props.forEach(function(name){save(sessionStorage,name,null),save(localStorage,name,null)})},new LoopBackAuth}).config(["$httpProvider",function($httpProvider){$httpProvider.interceptors.push("LoopBackAuthRequestInterceptor")}]).factory("LoopBackAuthRequestInterceptor",["$q","LoopBackAuth",function($q,LoopBackAuth){return{request:function(config){if(config.url.substr(0,urlBase.length)!==urlBase)return config;if(LoopBackAuth.accessTokenId)config.headers[authHeader]=LoopBackAuth.accessTokenId;else if(config.__isGetCurrentUser__){var res={body:{error:{status:401}},status:401,config:config,headers:function(){return undefined}};return $q.reject(res)}return config||$q.when(config)}}}]).provider("LoopBackResource",function(){this.setAuthHeader=function(header){authHeader=header},this.setUrlBase=function(url){urlBase=url},this.getUrlBase=function(){return urlBase},this.$get=["$resource",function($resource){return function(url,params,actions){var resource=$resource(url,params,actions);return resource.prototype.$save=function(success,error){var result=resource.upsert.call(this,{},this,success,error);return result.$promise||result},resource}}]})}(window,window.angular);
!function($){function Redactor(el,options){return new Redactor.prototype.init(el,options)}var uuid=0,rtePaste=!1,Range=function(range){return this[0]=range.startOffset,this[1]=range.endOffset,this.range=range,this};Range.prototype.equals=function(){return this[0]===this[1]},$.fn.redactor=function(options){var val=[],args=Array.prototype.slice.call(arguments,1);return"string"==typeof options?this.each(function(){var instance=$.data(this,"redactor");if("undefined"==typeof instance||!$.isFunction(instance[options]))return $.error('No such method "'+options+'" for Redactor');var methodVal=instance[options].apply(instance,args);void 0!==methodVal&&methodVal!==instance&&val.push(methodVal)}):this.each(function(){$.data(this,"redactor")||$.data(this,"redactor",Redactor(this,options))}),0===val.length?this:1===val.length?val[0]:val},$.Redactor=Redactor,$.Redactor.VERSION="9.1.3",$.Redactor.opts={rangy:!1,iframe:!1,fullpage:!1,css:!1,lang:"en",direction:"ltr",placeholder:!1,wym:!1,mobile:!0,cleanup:!0,tidyHtml:!0,pastePlainText:!1,removeEmptyTags:!0,templateVars:!1,visual:!0,focus:!1,tabindex:!1,autoresize:!0,minHeight:!1,shortcuts:!0,autosave:!1,autosaveInterval:60,plugins:!1,linkAnchor:!1,linkEmail:!1,linkProtocol:"http://",linkNofollow:!1,imageFloatMargin:"10px",imageGetJson:!1,imageUpload:!1,fileUpload:!1,clipboardUpload:!0,clipboardUploadUrl:!1,dragUpload:!0,dnbImageTypes:["image/png","image/jpeg","image/gif"],s3:!1,uploadFields:!1,observeImages:!0,observeLinks:!0,modalOverlay:!0,tabSpaces:!1,tabFocus:!0,air:!1,airButtons:["formatting","|","bold","italic","deleted","|","unorderedlist","orderedlist","outdent","indent"],toolbar:!0,toolbarFixed:!1,toolbarFixedTarget:document,toolbarFixedTopOffset:0,toolbarFixedBox:!1,toolbarExternal:!1,buttonSource:!0,buttonSeparator:'<li class="redactor_separator"></li>',buttonsCustom:{},buttonsAdd:[],buttons:["html","|","formatting","|","bold","italic","deleted","|","unorderedlist","orderedlist","outdent","indent","|","image","video","file","table","link","|","alignment","|","horizontalrule"],activeButtons:["deleted","italic","bold","underline","unorderedlist","orderedlist","alignleft","aligncenter","alignright","justify","table"],activeButtonsStates:{b:"bold",strong:"bold",i:"italic",em:"italic",del:"deleted",strike:"deleted",ul:"unorderedlist",ol:"orderedlist",u:"underline",tr:"table",td:"table",table:"table"},activeButtonsAdd:!1,formattingTags:["p","blockquote","pre","h1","h2","h3","h4","h5","h6"],linebreaks:!1,paragraphy:!0,convertDivs:!0,convertLinks:!0,convertImageLinks:!1,convertVideoLinks:!1,formattingPre:!1,phpTags:!1,allowedTags:!1,deniedTags:["html","head","link","body","meta","script","style","applet"],boldTag:"strong",italicTag:"em",indentValue:20,buffer:[],rebuffer:[],textareamode:!1,emptyHtml:"<p>&#x200b;</p>",invisibleSpace:"&#x200b;",rBlockTest:/^(P|H[1-6]|LI|ADDRESS|SECTION|HEADER|FOOTER|ASIDE|ARTICLE)$/i,alignmentTags:["P","H1","H2","H3","H4","H5","H6","DD","DL","DT","DIV","TD","BLOCKQUOTE","OUTPUT","FIGCAPTION","ADDRESS","SECTION","HEADER","FOOTER","ASIDE","ARTICLE"],ownLine:["area","body","head","hr","i?frame","link","meta","noscript","style","script","table","tbody","thead","tfoot"],contOwnLine:["li","dt","dt","h[1-6]","option","script"],newLevel:["blockquote","div","dl","fieldset","form","frameset","map","ol","p","pre","select","td","th","tr","ul"],blockLevelElements:["P","H1","H2","H3","H4","H5","H6","DD","DL","DT","DIV","LI","BLOCKQUOTE","OUTPUT","FIGCAPTION","PRE","ADDRESS","SECTION","HEADER","FOOTER","ASIDE","ARTICLE","TD"],langs:{en:{html:"HTML",video:"Insert Video",image:"Insert Image",table:"Table",link:"Link",link_insert:"Insert link",link_edit:"Edit link",unlink:"Unlink",formatting:"Formatting",paragraph:"Normal text",quote:"Quote",code:"Code",header1:"Header 1",header2:"Header 2",header3:"Header 3",header4:"Header 4",header5:"Header 5",bold:"Bold",italic:"Italic",fontcolor:"Font Color",backcolor:"Back Color",unorderedlist:"Unordered List",orderedlist:"Ordered List",outdent:"Outdent",indent:"Indent",cancel:"Cancel",insert:"Insert",save:"Save",_delete:"Delete",insert_table:"Insert Table",insert_row_above:"Add Row Above",insert_row_below:"Add Row Below",insert_column_left:"Add Column Left",insert_column_right:"Add Column Right",delete_column:"Delete Column",delete_row:"Delete Row",delete_table:"Delete Table",rows:"Rows",columns:"Columns",add_head:"Add Head",delete_head:"Delete Head",title:"Title",image_position:"Position",none:"None",left:"Left",right:"Right",image_web_link:"Image Web Link",text:"Text",mailto:"Email",web:"URL",video_html_code:"Video Embed Code",file:"Insert File",upload:"Upload",download:"Download",choose:"Choose",or_choose:"Or choose",drop_file_here:"Drop file here",align_left:"Align text to the left",align_center:"Center text",align_right:"Align text to the right",align_justify:"Justify text",horizontalrule:"Insert Horizontal Rule",deleted:"Deleted",anchor:"Anchor",link_new_tab:"Open link in new tab",underline:"Underline",alignment:"Alignment",filename:"Name (optional)",edit:"Edit"}}},Redactor.fn=$.Redactor.prototype={keyCode:{BACKSPACE:8,DELETE:46,DOWN:40,ENTER:13,ESC:27,TAB:9,CTRL:17,META:91,LEFT:37,LEFT_WIN:91},init:function(el,options){this.$element=this.$source=$(el),this.uuid=uuid++;var opts=$.extend(!0,{},$.Redactor.opts);if(this.opts=$.extend({},opts,this.$element.data(),options),this.start=!0,this.dropdowns=[],this.sourceHeight=this.$source.css("height"),this.sourceWidth=this.$source.css("width"),this.opts.fullpage&&(this.opts.iframe=!0),this.opts.linebreaks&&(this.opts.paragraphy=!1),this.opts.paragraphy&&(this.opts.linebreaks=!1),this.opts.toolbarFixedBox&&(this.opts.toolbarFixed=!0),this.document=document,this.window=window,this.savedSel=!1,this.cleanlineBefore=new RegExp("^<(/?"+this.opts.ownLine.join("|/?")+"|"+this.opts.contOwnLine.join("|")+")[ >]"),this.cleanlineAfter=new RegExp("^<(br|/?"+this.opts.ownLine.join("|/?")+"|/"+this.opts.contOwnLine.join("|/")+")[ >]"),this.cleannewLevel=new RegExp("^</?("+this.opts.newLevel.join("|")+")[ >]"),this.rTestBlock=new RegExp("^("+this.opts.blockLevelElements.join("|")+")$","i"),this.opts.linebreaks===!1&&(this.opts.allowedTags!==!1&&"-1"===$.inArray("p",this.opts.allowedTags)&&this.opts.allowedTags.push("p"),this.opts.deniedTags!==!1)){var pos=$.inArray("p",this.opts.deniedTags);"-1"!==pos&&this.opts.deniedTags.splice(pos,pos)}(this.browser("msie")||this.browser("opera"))&&(this.opts.buttons=this.removeFromArrayByValue(this.opts.buttons,"horizontalrule")),this.opts.curLang=this.opts.langs[this.opts.lang],this.buildStart()},initToolbar:function(lang){return{html:{title:lang.html,func:"toggle"},formatting:{title:lang.formatting,func:"show",dropdown:{p:{title:lang.paragraph,func:"formatBlocks"},blockquote:{title:lang.quote,func:"formatQuote",className:"redactor_format_blockquote"},pre:{title:lang.code,func:"formatBlocks",className:"redactor_format_pre"},h1:{title:lang.header1,func:"formatBlocks",className:"redactor_format_h1"},h2:{title:lang.header2,func:"formatBlocks",className:"redactor_format_h2"},h3:{title:lang.header3,func:"formatBlocks",className:"redactor_format_h3"},h4:{title:lang.header4,func:"formatBlocks",className:"redactor_format_h4"},h5:{title:lang.header5,func:"formatBlocks",className:"redactor_format_h5"}}},bold:{title:lang.bold,exec:"bold"},italic:{title:lang.italic,exec:"italic"},deleted:{title:lang.deleted,exec:"strikethrough"},underline:{title:lang.underline,exec:"underline"},unorderedlist:{title:"&bull; "+lang.unorderedlist,exec:"insertunorderedlist"},orderedlist:{title:"1. "+lang.orderedlist,exec:"insertorderedlist"},outdent:{title:"< "+lang.outdent,func:"indentingOutdent"},indent:{title:"> "+lang.indent,func:"indentingIndent"},image:{title:lang.image,func:"imageShow"},video:{title:lang.video,func:"videoShow"},file:{title:lang.file,func:"fileShow"},table:{title:lang.table,func:"show",dropdown:{insert_table:{title:lang.insert_table,func:"tableShow"},separator_drop1:{name:"separator"},insert_row_above:{title:lang.insert_row_above,func:"tableAddRowAbove"},insert_row_below:{title:lang.insert_row_below,func:"tableAddRowBelow"},insert_column_left:{title:lang.insert_column_left,func:"tableAddColumnLeft"},insert_column_right:{title:lang.insert_column_right,func:"tableAddColumnRight"},separator_drop2:{name:"separator"},add_head:{title:lang.add_head,func:"tableAddHead"},delete_head:{title:lang.delete_head,func:"tableDeleteHead"},separator_drop3:{name:"separator"},delete_column:{title:lang.delete_column,func:"tableDeleteColumn"},delete_row:{title:lang.delete_row,func:"tableDeleteRow"},delete_table:{title:lang.delete_table,func:"tableDeleteTable"}}},link:{title:lang.link,func:"show",dropdown:{link:{title:lang.link_insert,func:"linkShow"},unlink:{title:lang.unlink,exec:"unlink"}}},fontcolor:{title:lang.fontcolor,func:"show"},backcolor:{title:lang.backcolor,func:"show"},alignment:{title:lang.alignment,func:"show",dropdown:{alignleft:{title:lang.align_left,func:"alignmentLeft"},aligncenter:{title:lang.align_center,func:"alignmentCenter"},alignright:{title:lang.align_right,func:"alignmentRight"},justify:{title:lang.align_justify,func:"alignmentJustify"}}},alignleft:{title:lang.align_left,func:"alignmentLeft"},aligncenter:{title:lang.align_center,func:"alignmentCenter"},alignright:{title:lang.align_right,func:"alignmentRight"},justify:{title:lang.align_justify,func:"alignmentJustify"},horizontalrule:{exec:"inserthorizontalrule",title:lang.horizontalrule}}},callback:function(type,event,data){var callback=this.opts[type+"Callback"];return $.isFunction(callback)?event===!1?callback.call(this,data):callback.call(this,event,data):data},destroy:function(){clearInterval(this.autosaveInterval),$(window).off(".redactor"),this.$source.off("redactor-textarea"),this.$element.off(".redactor").removeData("redactor");var html=this.get();if(this.opts.textareamode)this.$box.after(this.$source),this.$box.remove(),this.$source.val(html).show();else{var $elem=this.$editor;this.opts.iframe&&($elem=this.$element),this.$box.after($elem),this.$box.remove(),$elem.removeClass("redactor_editor").removeClass("redactor_editor_wym").removeAttr("contenteditable").html(html).show()}this.opts.air&&$(".redactor_air").remove()},getObject:function(){return $.extend({},this)},getEditor:function(){return this.$editor},getBox:function(){return this.$box},getIframe:function(){return this.opts.iframe?this.$frame:!1},getToolbar:function(){return this.$toolbar},get:function(){return this.$source.val()},getCodeIframe:function(){this.$editor.removeAttr("contenteditable").removeAttr("dir");var html=this.outerHtml(this.$frame.contents().children());return this.$editor.attr({contenteditable:!0,dir:this.opts.direction}),html},set:function(html,strip,placeholderRemove){html=html.toString(),this.opts.fullpage?this.setCodeIframe(html):this.setEditor(html,strip),placeholderRemove!==!1&&this.placeholderRemove()},setEditor:function(html,strip){strip!==!1&&(html=this.cleanSavePreCode(html),html=this.cleanStripTags(html),html=this.cleanConvertProtected(html),html=this.cleanConvertInlineTags(html),html=this.opts.linebreaks===!1?this.cleanConverters(html):html.replace(/<p(.*?)>([\w\W]*?)<\/p>/gi,"$2<br>")),html=this.cleanEmpty(html),this.$editor.html(html),this.sync()},setCodeIframe:function(html){var doc=this.iframePage();this.$frame[0].src="about:blank",html=this.cleanConvertProtected(html),html=this.cleanConvertInlineTags(html),html=this.cleanRemoveSpaces(html),doc.open(),doc.write(html),doc.close(),this.opts.fullpage&&(this.$editor=this.$frame.contents().find("body").attr({contenteditable:!0,dir:this.opts.direction})),this.sync()},setFullpageOnInit:function(html){html=this.cleanSavePreCode(html,!0),html=this.cleanConverters(html),html=this.cleanEmpty(html),this.$editor.html(html),this.sync()},sync:function(){var html="";this.cleanUnverified(),html=this.opts.fullpage?this.getCodeIframe():this.$editor.html(),html=this.syncClean(html),html=this.cleanRemoveSpaces(html),html=this.cleanRemoveEmptyTags(html),html=html.replace(/<\/li><(ul|ol)>([\w\W]*?)<\/(ul|ol)>/gi,"<$1>$2</$1></li>"),"<br>"===$.trim(html)&&(html=""),""!==html&&this.opts.tidyHtml&&(html=this.cleanHtml(html)),html=this.callback("syncBefore",!1,html),this.$source.val(html),this.callback("syncAfter",!1,html),this.start===!1&&this.callback("change",!1,html)},syncClean:function(html){return this.opts.fullpage||(html=this.cleanStripTags(html)),html=$.trim(html),html=this.placeholderRemoveFromCode(html),html=html.replace(/&#x200b;/gi,""),html=html.replace(/&#8203;/gi,""),html=html.replace(/&nbsp;/gi," "),this.opts.linkNofollow&&(html=html.replace(/<a(.*?)rel="nofollow"(.*?)>/gi,"<a$1$2>"),html=html.replace(/<a(.*?)>/gi,'<a$1 rel="nofollow">')),html=html.replace("<!--?php","<?php"),html=html.replace("?-->","?>"),html=html.replace(/ data-tagblock=""/gi,""),html=html.replace(/<br\s?\/?>\n?<\/(P|H[1-6]|LI|ADDRESS|SECTION|HEADER|FOOTER|ASIDE|ARTICLE)>/gi,"</$1>"),html=html.replace(/<span(.*?)id="redactor-image-box"(.*?)>([\w\W]*?)<img(.*?)><\/span>/i,"$3<img$4>"),html=html.replace(/<span(.*?)id="redactor-image-resizer"(.*?)>(.*?)<\/span>/i,""),html=html.replace(/<span(.*?)id="redactor-image-editter"(.*?)>(.*?)<\/span>/i,""),html=html.replace(/<span\s*?>([\w\W]*?)<\/span>/gi,"$1"),html=html.replace(/<span(.*?)data-redactor="verified"(.*?)>([\w\W]*?)<\/span>/gi,"<span$1$2>$3</span>"),html=html.replace(/<span(.*?)data-redactor-inlineMethods=""(.*?)>([\w\W]*?)<\/span>/gi,"<span$1$2>$3</span>"),html=html.replace(/<span\s*?>([\w\W]*?)<\/span>/gi,"$1"),html=html.replace(/<span\s*?id="selection-marker(.*?)"(.*?)>([\w\W]*?)<\/span>/gi,""),html=html.replace(/<span\s*?>([\w\W]*?)<\/span>/gi,"$1"),html=html.replace(/<span(.*?)data-redactor="verified"(.*?)>([\w\W]*?)<\/span>/gi,"<span$1$2>$3</span>"),html=html.replace(/<span(.*?)data-redactor-inlineMethods=""(.*?)>([\w\W]*?)<\/span>/gi,"<span$1$2>$3</span>"),html=html.replace(/<span>([\w\W]*?)<\/span>/gi,"$1"),html=html.replace(/;amp;/gi,";"),html=this.cleanReConvertProtected(html)},buildStart:function(){this.content="",this.$box=$('<div class="redactor_box" />'),"TEXTAREA"===this.$source[0].tagName&&(this.opts.textareamode=!0),this.opts.mobile===!1&&this.isMobile()?this.buildMobile():(this.buildContent(),this.opts.iframe?(this.opts.autoresize=!1,this.iframeStart()):this.opts.textareamode?this.buildFromTextarea():this.buildFromElement(),this.opts.iframe||(this.buildOptions(),this.buildAfter()))},buildMobile:function(){this.opts.textareamode||(this.$editor=this.$source,this.$editor.hide(),this.$source=this.buildCodearea(this.$editor),this.$source.val(this.content)),this.$box.insertAfter(this.$source).append(this.$source)},buildContent:function(){this.opts.textareamode?this.content=$.trim(this.$source.val()):this.content=$.trim(this.$source.html())},buildFromTextarea:function(){this.$editor=$("<div />"),this.$box.insertAfter(this.$source).append(this.$editor).append(this.$source),this.buildAddClasses(this.$editor),this.buildEnable()},buildFromElement:function(){this.$editor=this.$source,this.$source=this.buildCodearea(this.$editor),this.$box.insertAfter(this.$editor).append(this.$editor).append(this.$source),this.buildEnable()},buildCodearea:function($source){return $("<textarea />").attr("name",$source.attr("id")).css("height",this.sourceHeight)},buildAddClasses:function(el){$.each(this.$source.get(0).className.split(/\s+/),function(i,s){el.addClass("redactor_"+s)})},buildEnable:function(){this.$editor.addClass("redactor_editor").attr({contenteditable:!0,dir:this.opts.direction}),this.$source.attr("dir",this.opts.direction).hide(),this.set(this.content,!0,!1)},buildOptions:function(){var $source=this.$editor;this.opts.iframe&&($source=this.$frame),this.opts.tabindex&&$source.attr("tabindex",this.opts.tabindex),this.opts.minHeight&&$source.css("min-height",this.opts.minHeight+"px"),this.opts.wym&&this.$editor.addClass("redactor_editor_wym"),this.opts.autoresize||$source.css("height",this.sourceHeight)},buildAfter:function(){if(this.start=!1,this.opts.toolbar&&(this.opts.toolbar=this.initToolbar(this.opts.curLang),this.toolbarBuild()),this.modalTemplatesInit(),this.buildPlugins(),this.buildBindKeyboard(),this.opts.autosave&&this.autosave(),setTimeout($.proxy(this.observeStart,this),4),this.browser("mozilla"))try{this.document.execCommand("enableObjectResizing",!1,!1),this.document.execCommand("enableInlineTableEditing",!1,!1)}catch(e){}this.opts.focus&&setTimeout($.proxy(this.focus,this),100),this.opts.visual||setTimeout($.proxy(function(){this.opts.visual=!0,this.toggle(!1)},this),200),this.callback("init")},buildBindKeyboard:function(){this.opts.dragUpload&&this.$editor.on("drop.redactor",$.proxy(this.buildEventDrop,this)),this.$editor.on("paste.redactor",$.proxy(this.buildEventPaste,this)),this.$editor.on("keydown.redactor",$.proxy(this.buildEventKeydown,this)),this.$editor.on("keyup.redactor",$.proxy(this.buildEventKeyup,this)),$.isFunction(this.opts.textareaKeydownCallback)&&this.$source.on("keydown.redactor-textarea",$.proxy(this.opts.textareaKeydownCallback,this)),$.isFunction(this.opts.focusCallback)&&this.$editor.on("focus.redactor",$.proxy(this.opts.focusCallback,this)),this.$editor.on("blur.redactor",$.proxy(function(){this.selectall=!1},this)),$.isFunction(this.opts.blurCallback)&&this.$editor.on("blur.redactor",$.proxy(this.opts.blurCallback,this))},buildEventDrop:function(e){if(e=e.originalEvent||e,void 0===window.FormData)return!0;var length=e.dataTransfer.files.length;if(0==length)return!0;e.preventDefault();var file=e.dataTransfer.files[0];if(this.opts.dnbImageTypes!==!1&&-1==this.opts.dnbImageTypes.indexOf(file.type))return!0;this.bufferSet();var progress=$('<div id="redactor-progress-drag" class="redactor-progress redactor-progress-striped"><div id="redactor-progress-bar" class="redactor-progress-bar" style="width: 100%;"></div></div>');$(document.body).append(progress),this.dragUploadAjax(this.opts.imageUpload,file,!0,progress,e)},buildEventPaste:function(e){var oldsafari=!1;if(this.browser("webkit")&&-1===navigator.userAgent.indexOf("Chrome")){var arr=this.browser("version").split(".");arr[0]<536&&(oldsafari=!0)}if(oldsafari)return!0;if(this.browser("opera"))return!0;if(this.opts.clipboardUpload&&this.buildEventClipboardUpload(e))return!0;if(this.opts.cleanup){rtePaste=!0,this.selectionSave(),this.selectall||(this.opts.autoresize===!0?(this.$editor.height(this.$editor.height()),this.saveScroll=this.document.body.scrollTop):this.saveScroll=this.$editor.scrollTop());var frag=this.extractContent();setTimeout($.proxy(function(){var pastedFrag=this.extractContent();this.$editor.append(frag),this.selectionRestore();var html=this.getFragmentHtml(pastedFrag);this.pasteClean(html),this.opts.autoresize===!0&&this.$editor.css("height","auto")},this),1)}},buildEventClipboardUpload:function(e){var event=e.originalEvent||e;if(this.clipboardFilePaste=!1,event.clipboardData.items){var file=event.clipboardData.items[0].getAsFile();if(null!==file){this.bufferSet(),this.clipboardFilePaste=!0;var reader=new FileReader;return reader.onload=$.proxy(this.pasteClipboardUpload,this),reader.readAsDataURL(file),!0}}return!1},buildEventKeydown:function(e){if(rtePaste)return!1;var key=e.which,ctrl=e.ctrlKey||e.metaKey,parent=this.getParent(),current=this.getCurrent(),block=this.getBlock(),pre=!1;if(this.callback("keydown",e),this.imageResizeHide(!1),(parent&&"PRE"===$(parent).get(0).tagName||current&&"PRE"===$(current).get(0).tagName)&&(pre=!0,key===this.keyCode.DOWN&&this.insertAfterLastElement(block)),key===this.keyCode.DOWN&&(parent&&"BLOCKQUOTE"===$(parent).get(0).tagName&&this.insertAfterLastElement(parent),current&&"BLOCKQUOTE"===$(current).get(0).tagName&&this.insertAfterLastElement(current)),ctrl&&!e.shiftKey&&this.shortcuts(e,key),ctrl&&90===key&&!e.shiftKey&&!e.altKey)return e.preventDefault(),void(this.opts.buffer.length?this.bufferUndo():this.document.execCommand("undo",!1,!1));if(ctrl&&90===key&&e.shiftKey&&!e.altKey)return e.preventDefault(),void(0!=this.opts.rebuffer.length?this.bufferRedo():this.document.execCommand("redo",!1,!1));if(ctrl&&65===key?this.selectall=!0:key==this.keyCode.LEFT_WIN||ctrl||(this.selectall=!1),key!=this.keyCode.ENTER||e.shiftKey||e.ctrlKey||e.metaKey)key===this.keyCode.ENTER&&(e.ctrlKey||e.shiftKey)&&(this.bufferSet(),e.preventDefault(),this.insertLineBreak());else{if(1==parent.nodeType&&("TD"==parent.tagName||"TH"==parent.tagName))return e.preventDefault(),this.bufferSet(),this.insertNode(document.createElement("br")),this.callback("enter",e),!1;if(pre===!0){e.preventDefault(),this.bufferSet();var html=$(current).parent().text();return this.insertNode(document.createTextNode("\n")),-1==html.search(/\s$/)&&this.insertNode(document.createTextNode("\n")),this.sync(),this.callback("enter",e),!1}if(!this.opts.linebreaks)if(block&&this.opts.rBlockTest.test(block.tagName))this.bufferSet(),setTimeout($.proxy(function(){var blockElem=this.getBlock();if("DIV"===blockElem.tagName&&!$(blockElem).hasClass("redactor_editor")){var node=$("<p>"+this.opts.invisibleSpace+"</p>");$(blockElem).replaceWith(node),this.selectionStart(node)}},this),1);else if(block===!1){this.bufferSet();var node=$("<p>"+this.opts.invisibleSpace+"</p>");return this.insertNode(node[0]),this.selectionStart(node),this.callback("enter",e),!1}if(this.opts.linebreaks){if(!block||!this.opts.rBlockTest.test(block.tagName))return this.buildEventKeydownInsertLineBreak(e);this.bufferSet(),setTimeout($.proxy(function(){var blockElem=this.getBlock();"DIV"!==blockElem.tagName&&"P"!==blockElem.tagName||$(blockElem).hasClass("redactor_editor")||this.replaceLineBreak(blockElem)},this),1)}if("BLOCKQUOTE"==block.tagName||"FIGCAPTION"==block.tagName)return this.buildEventKeydownInsertLineBreak(e);this.callback("enter",e)}if(key===this.keyCode.TAB&&this.opts.shortcuts)return this.opts.tabFocus?this.isEmpty(this.get())?!0:(e.preventDefault(),pre!==!0||e.shiftKey?this.opts.tabSpaces!==!1?(this.bufferSet(),this.insertNode(document.createTextNode(Array(this.opts.tabSpaces+1).join(""))),this.sync(),!1):(e.shiftKey?this.indentingOutdent():this.indentingIndent(),!1):(this.bufferSet(),this.insertNode(document.createTextNode("	")),this.sync(),!1)):!0;if(key===this.keyCode.BACKSPACE){if("undefined"!=typeof current.tagName&&/^(H[1-6])$/i.test(current.tagName)){var node;node=$(this.opts.linebreaks===!1?"<p>"+this.opts.invisibleSpace+"</p>":"<br>"+this.opts.invisibleSpace),$(current).replaceWith(node),this.selectionStart(node)}if("undefined"!=typeof current.nodeValue&&null!==current.nodeValue){var value=$.trim(current.nodeValue.replace(/[^\u0000-\u1C7F]/g,""));current.remove&&3===current.nodeType&&8203==current.nodeValue.charCodeAt(0)&&""==value&&current.remove()}}},buildEventKeydownInsertLineBreak:function(e){this.bufferSet(),e.preventDefault(),this.insertLineBreak(),this.callback("enter",e)},buildEventKeyup:function(e){if(rtePaste)return!1;var key=e.which,parent=this.getParent(),current=this.getCurrent();if(!this.opts.linebreaks&&3==current.nodeType&&(0==parent||"BODY"==parent.tagName)){var node=$("<p>").append($(current).clone());$(current).replaceWith(node);var next=$(node).next();"undefined"!=typeof next[0]&&"BR"==next[0].tagName&&next.remove(),this.selectionEnd(node)}return(this.opts.convertLinks||this.opts.convertImageLinks||this.opts.convertVideoLinks)&&key===this.keyCode.ENTER&&(this.formatLinkify(this.opts.linkProtocol,this.opts.convertLinks,this.opts.convertImageLinks,this.opts.convertVideoLinks),setTimeout($.proxy(function(){this.opts.convertImageLinks&&this.observeImages(),this.opts.observeLinks&&this.observeLinks()},this),5)),this.opts.linebreaks!==!1||key!==this.keyCode.DELETE&&key!==this.keyCode.BACKSPACE?(this.callback("keyup",e),void this.sync()):this.formatEmpty(e)},buildPlugins:function(){this.opts.plugins&&$.each(this.opts.plugins,$.proxy(function(i,s){RedactorPlugins[s]&&($.extend(this,RedactorPlugins[s]),$.isFunction(RedactorPlugins[s].init)&&this.init())},this))},iframeStart:function(){this.iframeCreate(),this.opts.textareamode?this.iframeAppend(this.$source):(this.$sourceOld=this.$source.hide(),this.$source=this.buildCodearea(this.$sourceOld),this.iframeAppend(this.$sourceOld))},iframeAppend:function(el){this.$source.attr("dir",this.opts.direction).hide(),this.$box.insertAfter(el).append(this.$frame).append(this.$source)},iframeCreate:function(){this.$frame=$('<iframe style="width: 100%;" frameborder="0" />').one("load",$.proxy(function(){if(this.opts.fullpage){this.iframePage(),""===this.content&&(this.content=this.opts.invisibleSpace),this.$frame.contents()[0].write(this.content),this.$frame.contents()[0].close();var timer=setInterval($.proxy(function(){this.$frame.contents().find("body").html()&&(clearInterval(timer),this.iframeLoad())},this),0)}else this.iframeLoad()},this))},iframeDoc:function(){return this.$frame[0].contentWindow.document},iframePage:function(){var doc=this.iframeDoc();return doc.documentElement&&doc.removeChild(doc.documentElement),doc},iframeAddCss:function(css){css=css||this.opts.css,this.isString(css)&&this.$frame.contents().find("head").append('<link rel="stylesheet" href="'+css+'" />'),$.isArray(css)&&$.each(css,$.proxy(function(i,url){this.iframeAddCss(url)},this))},iframeLoad:function(){this.$editor=this.$frame.contents().find("body").attr({contenteditable:!0,dir:this.opts.direction}),this.$editor[0]&&(this.document=this.$editor[0].ownerDocument,this.window=this.document.defaultView||window),this.iframeAddCss(),this.opts.fullpage?this.setFullpageOnInit(this.$editor.html()):this.set(this.content,!0,!1),this.buildOptions(),this.buildAfter()},placeholderStart:function(html){return this.isEmpty(html)&&(this.$element.attr("placeholder")&&(this.opts.placeholder=this.$element.attr("placeholder")),""===this.opts.placeholder&&(this.opts.placeholder=!1),this.opts.placeholder!==!1)?(this.opts.focus=!1,this.$editor.one("focus.redactor_placeholder",$.proxy(this.placeholderFocus,this)),$('<span class="redactor_placeholder" data-redactor="verified">').attr("contenteditable",!1).text(this.opts.placeholder)):!1},placeholderFocus:function(){this.$editor.find("span.redactor_placeholder").remove();var html="";this.opts.linebreaks===!1&&(html=this.opts.emptyHtml),this.$editor.off("focus.redactor_placeholder"),this.$editor.html(html),this.opts.linebreaks===!1&&this.selectionStart(this.$editor.children()[0]),this.sync()},placeholderRemove:function(){this.opts.placeholder=!1,this.$editor.find("span.redactor_placeholder").remove(),this.$editor.off("focus.redactor_placeholder")},placeholderRemoveFromCode:function(html){return html.replace(/<span class="redactor_placeholder"(.*?)>(.*?)<\/span>/i,"")},shortcuts:function(e,key){this.opts.shortcuts&&(e.altKey?48===key?this.shortcutsLoadFormat(e,"p"):49===key?this.shortcutsLoadFormat(e,"h1"):50===key?this.shortcutsLoadFormat(e,"h2"):51===key?this.shortcutsLoadFormat(e,"h3"):52===key?this.shortcutsLoadFormat(e,"h4"):53===key?this.shortcutsLoadFormat(e,"h5"):54===key&&this.shortcutsLoadFormat(e,"h6"):77===key?this.shortcutsLoad(e,"removeFormat"):66===key?this.shortcutsLoad(e,"bold"):73===key?this.shortcutsLoad(e,"italic"):74===key?this.shortcutsLoad(e,"insertunorderedlist"):75===key?this.shortcutsLoad(e,"insertorderedlist"):72===key?this.shortcutsLoad(e,"superscript"):76===key&&this.shortcutsLoad(e,"subscript"))},shortcutsLoad:function(e,cmd){e.preventDefault(),this.execCommand(cmd,!1)},shortcutsLoadFormat:function(e,cmd){e.preventDefault(),this.formatBlocks(cmd)},focus:function(){this.browser("opera")?this.$editor.focus():this.window.setTimeout($.proxy(this.focusSet,this,!0),1)},focusEnd:function(){this.focusSet()},focusSet:function(collapse){this.$editor.focus();var range=this.getRange();range.selectNodeContents(this.$editor[0]),range.collapse(collapse||!1);var sel=this.getSelection();sel.removeAllRanges(),sel.addRange(range)},toggle:function(direct){var html;if(this.opts.visual){direct!==!1&&this.selectionSave();var height=null;this.opts.iframe?(height=this.$frame.height(),this.opts.fullpage&&this.$editor.removeAttr("contenteditable"),this.$frame.hide()):(height=this.$editor.innerHeight(),this.$editor.hide()),html=this.$source.val(),this.modified=html,this.$source.height(height).show().focus(),this.$source.on("keydown.redactor-textarea-indenting",function(e){if(9===e.keyCode){var $el=$(this),start=$el.get(0).selectionStart;return $el.val($el.val().substring(0,start)+"	"+$el.val().substring($el.get(0).selectionEnd)),$el.get(0).selectionStart=$el.get(0).selectionEnd=start+1,!1}}),this.buttonInactiveVisual(),this.buttonActive("html"),this.opts.visual=!1}else html=this.$source.hide().val(),"undefined"!=typeof this.modified&&(this.modified=this.cleanRemoveSpaces(this.modified,!1)!==this.cleanRemoveSpaces(html,!1)),this.modified&&(this.opts.fullpage&&""===html?this.setFullpageOnInit(html):(this.set(html),this.opts.fullpage&&this.buildBindKeyboard())),this.opts.iframe?this.$frame.show():this.$editor.show(),this.opts.fullpage&&this.$editor.attr("contenteditable",!0),this.$source.off("keydown.redactor-textarea-indenting"),this.$editor.focus(),this.selectionRestore(),this.observeStart(),this.buttonActiveVisual(),this.buttonInactive("html"),this.opts.visual=!0},autosave:function(){var savedHtml=!1;this.autosaveInterval=setInterval($.proxy(function(){var html=this.get();savedHtml!==html&&$.ajax({url:this.opts.autosave,type:"post",data:this.$source.attr("name")+"="+escape(encodeURIComponent(html)),success:$.proxy(function(data){this.callback("autosave",!1,data),savedHtml=html},this)})},this),1e3*this.opts.autosaveInterval)},toolbarBuild:function(){if(this.opts.air)this.opts.buttons=this.opts.airButtons;else if(!this.opts.buttonSource){var index=this.opts.buttons.indexOf("html"),next=this.opts.buttons[index+1];this.opts.buttons.splice(index,1),"|"===next&&this.opts.buttons.splice(index,1)}if($.extend(this.opts.toolbar,this.opts.buttonsCustom),$.each(this.opts.buttonsAdd,$.proxy(function(i,s){this.opts.buttons.push(s)},this)),this.opts.toolbar&&$.each(this.opts.toolbar.formatting.dropdown,$.proxy(function(i,s){"-1"==$.inArray(i,this.opts.formattingTags)&&delete this.opts.toolbar.formatting.dropdown[i]},this)),0===this.opts.buttons.length)return!1;if(this.airEnable(),this.$toolbar=$("<ul>").addClass("redactor_toolbar").attr("id","redactor_toolbar_"+this.uuid),this.opts.air?(this.$air=$('<div class="redactor_air">').attr("id","redactor_air_"+this.uuid).hide(),this.$air.append(this.$toolbar),$("body").append(this.$air)):this.opts.toolbarExternal?$(this.opts.toolbarExternal).html(this.$toolbar):this.$box.prepend(this.$toolbar),$.each(this.opts.buttons,$.proxy(function(i,btnName){if("|"===btnName)this.$toolbar.append($(this.opts.buttonSeparator));else if(this.opts.toolbar[btnName]){var btnObject=this.opts.toolbar[btnName];if(this.opts.fileUpload===!1&&"file"===btnName)return!0;this.$toolbar.append($("<li>").append(this.buttonBuild(btnName,btnObject)))}},this)),this.$toolbar.find("a").attr("tabindex","-1"),this.opts.toolbarFixed&&(this.toolbarObserveScroll(),$(this.opts.toolbarFixedTarget).on("scroll.redactor",$.proxy(this.toolbarObserveScroll,this))),this.opts.activeButtons){var buttonActiveObserver=$.proxy(this.buttonActiveObserver,this);this.$editor.on("mouseup.redactor keyup.redactor",buttonActiveObserver)}},toolbarObserveScroll:function(){var scrollTop=$(this.opts.toolbarFixedTarget).scrollTop(),boxTop=this.$box.offset().top,left=0,end=boxTop+this.$box.height()+40;if(scrollTop>boxTop){var width="100%";this.opts.toolbarFixedBox&&(left=this.$box.offset().left,width=this.$box.innerWidth(),this.$toolbar.addClass("toolbar_fixed_box")),this.toolbarFixed=!0,this.$toolbar.css({position:"fixed",width:width,zIndex:1005,top:this.opts.toolbarFixedTopOffset+"px",left:left}),end>scrollTop?this.$toolbar.css("visibility","visible"):this.$toolbar.css("visibility","hidden")}else this.toolbarFixed=!1,this.$toolbar.css({position:"relative",width:"auto",top:0,left:left}),this.opts.toolbarFixedBox&&this.$toolbar.removeClass("toolbar_fixed_box");
},airEnable:function(){this.opts.air&&this.$editor.on("mouseup.redactor keyup.redactor",this,$.proxy(function(e){var text=this.getSelectionText();if("mouseup"===e.type&&""!=text&&this.airShow(e),"keyup"===e.type&&e.shiftKey&&""!=text){var $focusElem=$(this.getElement(this.getSelection().focusNode)),offset=$focusElem.offset();offset.height=$focusElem.height(),this.airShow(offset,!0)}},this))},airShow:function(e,keyboard){if(this.opts.air){var left,top;if($(".redactor_air").hide(),keyboard)left=e.left,top=e.top+e.height+14,this.opts.iframe&&(top+=this.$box.position().top-$(this.document).scrollTop(),left+=this.$box.position().left);else{var width=this.$air.innerWidth();left=e.clientX,$(this.document).width()<left+width&&(left-=width),top=e.clientY+14,this.opts.iframe?(top+=this.$box.position().top,left+=this.$box.position().left):top+=$(this.document).scrollTop()}this.$air.css({left:left+"px",top:top+"px"}).show(),this.airBindHide()}},airBindHide:function(){if(this.opts.air){var hideHandler=$.proxy(function(doc){$(doc).on("mousedown.redactor",$.proxy(function(e){0===$(e.target).closest(this.$toolbar).length&&(this.$air.fadeOut(100),this.selectionRemove(),$(doc).off(e))},this)).on("keydown.redactor",$.proxy(function(e){e.which===this.keyCode.ESC&&this.getSelection().collapseToStart(),this.$air.fadeOut(100),$(doc).off(e)},this))},this);hideHandler(document),this.opts.iframe&&hideHandler(this.document)}},airBindMousemoveHide:function(){if(this.opts.air){var hideHandler=$.proxy(function(doc){$(doc).on("mousemove.redactor",$.proxy(function(e){0===$(e.target).closest(this.$toolbar).length&&(this.$air.fadeOut(100),$(doc).off(e))},this))},this);hideHandler(document),this.opts.iframe&&hideHandler(this.document)}},dropdownBuild:function($dropdown,dropdownObject){$.each(dropdownObject,$.proxy(function(btnName,btnObject){btnObject.className||(btnObject.className="");var $item;"separator"===btnObject.name?$item=$('<a class="redactor_separator_drop">'):($item=$('<a href="#" class="'+btnObject.className+" redactor_dropdown_"+btnName+'">'+btnObject.title+"</a>"),$item.on("click",$.proxy(function(e){e.preventDefault&&e.preventDefault(),this.browser("msie")&&(e.returnValue=!1),btnObject.callback&&btnObject.callback.call(this,btnName,$item,btnObject,e),btnObject.exec&&this.execCommand(btnObject.exec,btnName),btnObject.func&&this[btnObject.func](btnName),this.buttonActiveObserver(),this.opts.air&&this.$air.fadeOut(100)},this))),$dropdown.append($item)},this))},dropdownShow:function(e,key){if(!this.opts.visual)return e.preventDefault(),!1;var $dropdown=this.$toolbar.find(".redactor_dropdown_box_"+key),$button=this.buttonGet(key);if($button.hasClass("dropact"))this.dropdownHideAll();else{this.dropdownHideAll(),this.buttonActive(key),$button.addClass("dropact");var keyPosition=$button.position();this.toolbarFixed&&(keyPosition=$button.offset());var dropdownWidth=$dropdown.width();keyPosition.left+dropdownWidth>$(document).width()&&(keyPosition.left-=dropdownWidth);var left=keyPosition.left+"px",btnHeight=29,position="absolute",top=btnHeight+"px";this.opts.toolbarFixed&&this.toolbarFixed?position="fixed":this.opts.air||(top=keyPosition.top+btnHeight+"px"),$dropdown.css({position:position,left:left,top:top}).show()}var hdlHideDropDown=$.proxy(function(e){this.dropdownHide(e,$dropdown)},this);$(document).one("click",hdlHideDropDown),this.$editor.one("click",hdlHideDropDown),e.stopPropagation()},dropdownHideAll:function(){this.$toolbar.find("a.dropact").removeClass("redactor_act").removeClass("dropact"),$(".redactor_dropdown").hide()},dropdownHide:function(e,$dropdown){$(e.target).hasClass("dropact")||($dropdown.removeClass("dropact"),this.dropdownHideAll())},buttonBuild:function(btnName,btnObject){var $button=$('<a href="javascript:;" title="'+btnObject.title+'" class="redactor_btn redactor_btn_'+btnName+'"></a>');if($button.on("click",$.proxy(function(e){return e.preventDefault&&e.preventDefault(),this.browser("msie")&&(e.returnValue=!1),$button.hasClass("redactor_button_disabled")?!1:(this.isFocused()!==!1||btnObject.exec||this.$editor.focus(),btnObject.exec?(this.$editor.focus(),this.execCommand(btnObject.exec,btnName),this.airBindMousemoveHide()):btnObject.func&&"show"!==btnObject.func?(this[btnObject.func](btnName),this.airBindMousemoveHide()):btnObject.callback?(btnObject.callback.call(this,btnName,$button,btnObject,e),this.airBindMousemoveHide()):btnObject.dropdown&&this.dropdownShow(e,btnName),void this.buttonActiveObserver(!1,btnName))},this)),btnObject.dropdown){var $dropdown=$('<div class="redactor_dropdown redactor_dropdown_box_'+btnName+'" style="display: none;">');$dropdown.appendTo(this.$toolbar),this.dropdownBuild($dropdown,btnObject.dropdown)}return $button},buttonGet:function(key){return this.opts.toolbar?$(this.$toolbar.find("a.redactor_btn_"+key)):!1},buttonActiveToggle:function(key){var btn=this.buttonGet(key);btn.hasClass("redactor_act")?btn.removeClass("redactor_act"):btn.addClass("redactor_act")},buttonActive:function(key){this.buttonGet(key).addClass("redactor_act")},buttonInactive:function(key){this.buttonGet(key).removeClass("redactor_act")},buttonInactiveAll:function(btnName){$.each(this.opts.toolbar,$.proxy(function(k){k!=btnName&&this.buttonInactive(k)},this))},buttonActiveVisual:function(){this.$toolbar.find("a.redactor_btn").not("a.redactor_btn_html").removeClass("redactor_button_disabled")},buttonInactiveVisual:function(){this.$toolbar.find("a.redactor_btn").not("a.redactor_btn_html").addClass("redactor_button_disabled")},buttonChangeIcon:function(key,classname){this.buttonGet(key).addClass("redactor_btn_"+classname)},buttonRemoveIcon:function(key,classname){this.buttonGet(key).removeClass("redactor_btn_"+classname)},buttonAddSeparator:function(){this.$toolbar.append($(this.opts.buttonSeparator))},buttonAddSeparatorAfter:function(key){this.buttonGet(key).parent().after($(this.opts.buttonSeparator))},buttonAddSeparatorBefore:function(key){this.buttonGet(key).parent().before($(this.opts.buttonSeparator))},buttonRemoveSeparatorAfter:function(key){this.buttonGet(key).parent().next().remove()},buttonRemoveSeparatorBefore:function(key){this.buttonGet(key).parent().prev().remove()},buttonSetRight:function(key){this.opts.toolbar&&this.buttonGet(key).parent().addClass("redactor_btn_right")},buttonSetLeft:function(key){this.opts.toolbar&&this.buttonGet(key).parent().removeClass("redactor_btn_right")},buttonAdd:function(key,title,callback,dropdown){if(this.opts.toolbar){var btn=this.buttonBuild(key,{title:title,callback:callback,dropdown:dropdown});this.$toolbar.append($("<li>").append(btn))}},buttonAddFirst:function(key,title,callback,dropdown){if(this.opts.toolbar){var btn=this.buttonBuild(key,{title:title,callback:callback,dropdown:dropdown});this.$toolbar.prepend($("<li>").append(btn))}},buttonAddAfter:function(afterkey,key,title,callback,dropdown){if(this.opts.toolbar){var btn=this.buttonBuild(key,{title:title,callback:callback,dropdown:dropdown}),$btn=this.buttonGet(afterkey);0!==$btn.size()?$btn.parent().after($("<li>").append(btn)):this.$toolbar.append($("<li>").append(btn))}},buttonAddBefore:function(beforekey,key,title,callback,dropdown){if(this.opts.toolbar){var btn=this.buttonBuild(key,{title:title,callback:callback,dropdown:dropdown}),$btn=this.buttonGet(beforekey);0!==$btn.size()?$btn.parent().before($("<li>").append(btn)):this.$toolbar.append($("<li>").append(btn))}},buttonRemove:function(key,separator){var $btn=this.buttonGet(key);separator&&$btn.parent().next().remove(),$btn.parent().removeClass("redactor_btn_right"),$btn.remove()},buttonActiveObserver:function(e,btnName){var parent=this.getParent();if(this.buttonInactiveAll(btnName),e===!1&&"html"!==btnName)return void(-1!=$.inArray(btnName,this.opts.activeButtons)&&this.buttonActiveToggle(btnName));parent&&"A"===parent.tagName?this.$toolbar.find("a.redactor_dropdown_link").text(this.opts.curLang.link_edit):this.$toolbar.find("a.redactor_dropdown_link").text(this.opts.curLang.link_insert),this.opts.activeButtonsAdd&&($.each(this.opts.activeButtonsAdd,$.proxy(function(i,s){this.opts.activeButtons.push(s)},this)),$.extend(this.opts.activeButtonsStates,this.opts.activeButtonsAdd)),$.each(this.opts.activeButtonsStates,$.proxy(function(key,value){0!=$(parent).closest(key,this.$editor.get()[0]).length&&this.buttonActive(value)},this));var $parent=$(parent).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0]);if($parent.length){var align=$parent.css("text-align");switch(align){case"right":this.buttonActive("alignright");break;case"center":this.buttonActive("aligncenter");break;case"justify":this.buttonActive("justify");break;default:this.buttonActive("alignleft")}}},exec:function(cmd,param,sync){"formatblock"===cmd&&this.browser("msie")&&(param="<"+param+">"),"inserthtml"===cmd&&this.browser("msie")?(this.$editor.focus(),this.document.selection.createRange().pasteHTML(param)):this.document.execCommand(cmd,!1,param),sync!==!1&&this.sync(),this.callback("execCommand",cmd,param)},execCommand:function(cmd,param,sync){if(!this.opts.visual)return this.$source.focus(),!1;if("inserthtml"===cmd)return this.insertHtml(param,sync),void this.callback("execCommand",cmd,param);if(this.currentOrParentIs("PRE")&&!this.opts.formattingPre)return!1;if("insertunorderedlist"===cmd||"insertorderedlist"===cmd){this.bufferSet();var parent=this.getParent(),$list=$(parent).closest("ol, ul"),remove=!1;if($list.length){remove=!0;var listTag=$list[0].tagName;("insertunorderedlist"===cmd&&"OL"===listTag||"insertorderedlist"===cmd&&"UL"===listTag)&&(remove=!1)}if(this.selectionSave(),remove){var nodes=this.getNodes(),elems=this.getBlocks(nodes);"undefined"!=typeof nodes[0]&&nodes.length>1&&3==nodes[0].nodeType&&elems.unshift(this.getBlock());var data="",replaced="";$.each(elems,$.proxy(function(i,s){if("LI"==s.tagName){var $s=$(s),cloned=$s.clone();cloned.find("ul","ol").remove(),data+=this.opts.linebreaks===!1?this.outerHtml($("<p>").append(cloned.contents())):cloned.html()+"<br>",0==i?($s.addClass("redactor-replaced").empty(),replaced=this.outerHtml($s)):$s.remove()}},this)),html=this.$editor.html().replace(replaced,"</"+listTag+">"+data+"<"+listTag+">"),this.$editor.html(html),this.$editor.find(listTag+":empty").remove()}else{this.document.execCommand(cmd);var parent=this.getParent(),$list=$(parent).closest("ol, ul");if($list.length){(this.browser("msie")||this.browser("mozilla"))&&"LI"!==parent.tagName&&$(parent).replaceWith($(parent).html());var $listParent=$list.parent();this.isParentRedactor($listParent)&&this.nodeTestBlocks($listParent[0])&&$listParent.replaceWith($listParent.contents())}this.browser("mozilla")&&this.$editor.focus()}return this.selectionRestore(),this.sync(),void this.callback("execCommand",cmd,param)}if("unlink"===cmd){this.bufferSet();var link=this.currentOrParentIs("A");if(link)return $(link).replaceWith($(link).text()),this.sync(),void this.callback("execCommand",cmd,param)}this.exec(cmd,param,sync),"inserthorizontalrule"===cmd&&this.$editor.find("hr").removeAttr("id")},indentingIndent:function(){this.indentingStart("indent")},indentingOutdent:function(){this.indentingStart("outdent")},indentingStart:function(cmd){if(this.bufferSet(),"indent"===cmd){var block=this.getBlock();if(this.selectionSave(),block&&"LI"==block.tagName){var parent=this.getParent(),$list=$(parent).closest("ol, ul"),listTag=$list[0].tagName,elems=this.getBlocks();$.each(elems,function(i,s){if("LI"==s.tagName){var $prev=$(s).prev();if(0!=$prev.size()&&"LI"==$prev[0].tagName){var $childList=$prev.children("ul, ol");0==$childList.size()?$prev.append($("<"+listTag+">").append(s)):$childList.append(s)}}})}else if(block===!1&&this.opts.linebreaks===!0){this.exec("formatBlock","blockquote");var newblock=this.getBlock(),block=$('<div data-tagblock="">').html($(newblock).html());$(newblock).replaceWith(block);var left=this.normalize($(block).css("margin-left"))+this.opts.indentValue;$(block).css("margin-left",left+"px")}else{var elements=this.getBlocks();$.each(elements,$.proxy(function(i,elem){var $el=!1;if("TD"!==elem.tagName){$el=-1!==$.inArray(elem.tagName,this.opts.alignmentTags)?$(elem):$(elem).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0]);var left=this.normalize($el.css("margin-left"))+this.opts.indentValue;$el.css("margin-left",left+"px")}},this))}this.selectionRestore()}else{this.selectionSave();var block=this.getBlock();if(block&&"LI"==block.tagName){var elems=this.getBlocks(),index=0;this.insideOutdent(block,index,elems)}else{var elements=this.getBlocks();$.each(elements,$.proxy(function(i,elem){var $el=!1;$el=-1!==$.inArray(elem.tagName,this.opts.alignmentTags)?$(elem):$(elem).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0]);var left=this.normalize($el.css("margin-left"))-this.opts.indentValue;0>=left?this.opts.linebreaks===!0&&"undefined"!=typeof $el.data("tagblock")?$el.replaceWith($el.html()):($el.css("margin-left",""),this.removeEmptyAttr($el,"style")):$el.css("margin-left",left+"px")},this))}this.selectionRestore()}},insideOutdent:function(li,index,elems){if(li&&"LI"==li.tagName){var $parent=$(li).parent().parent();0!=$parent.size()&&"LI"==$parent[0].tagName?$parent.after(li):"undefined"!=typeof elems[index]?(li=elems[index],index++,this.insideOutdent(li,index,elems)):this.execCommand("insertunorderedlist")}},cleanEmpty:function(html){var ph=this.placeholderStart(html);return ph!==!1?ph:(this.opts.linebreaks===!1&&(""===html?html=this.opts.emptyHtml:-1!==html.search(/^<hr\s?\/?>$/gi)&&(html="<hr>"+this.opts.emptyHtml)),html)},cleanConverters:function(html){return this.opts.convertDivs&&(html=html.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,"<p$1>$2</p>")),this.opts.paragraphy&&(html=this.cleanParagraphy(html)),html},cleanConvertProtected:function(html){return this.opts.templateVars&&(html=html.replace(/\{\{(.*?)\}\}/gi,"<!-- template double $1 -->"),html=html.replace(/\{(.*?)\}/gi,"<!-- template $1 -->")),html=html.replace(/<script(.*?)>([\w\W]*?)<\/script>/gi,'<title type="text/javascript" style="display: none;" class="redactor-script-tag"$1>$2</title>'),html=html.replace(/<style(.*?)>([\w\W]*?)<\/style>/gi,'<section$1 style="display: none;" rel="redactor-style-tag">$2</section>'),html=html.replace(/<form(.*?)>([\w\W]*?)<\/form>/gi,'<section$1 rel="redactor-form-tag">$2</section>'),html=this.opts.phpTags?html.replace(/<\?php([\w\W]*?)\?>/gi,'<section style="display: none;" rel="redactor-php-tag">$1</section>'):html.replace(/<\?php([\w\W]*?)\?>/gi,"")},cleanReConvertProtected:function(html){return this.opts.templateVars&&(html=html.replace(/<!-- template double (.*?) -->/gi,"{{$1}}"),html=html.replace(/<!-- template (.*?) -->/gi,"{$1}")),html=html.replace(/<title type="text\/javascript" style="display: none;" class="redactor-script-tag"(.*?)>([\w\W]*?)<\/title>/gi,'<script$1 type="text/javascript">$2</script>'),html=html.replace(/<section(.*?) style="display: none;" rel="redactor-style-tag">([\w\W]*?)<\/section>/gi,"<style$1>$2</style>"),html=html.replace(/<section(.*?)rel="redactor-form-tag"(.*?)>([\w\W]*?)<\/section>/gi,"<form$1$2>$3</form>"),this.opts.phpTags&&(html=html.replace(/<section style="display: none;" rel="redactor-php-tag">([\w\W]*?)<\/section>/gi,"<?php\r\n$1\r\n?>")),html},cleanRemoveSpaces:function(html,buffer){if(buffer!==!1){var buffer=[],matches=html.match(/<(pre|style|script|title)(.*?)>([\w\W]*?)<\/(pre|style|script|title)>/gi);if(null===matches&&(matches=[]),this.opts.phpTags){var phpMatches=html.match(/<\?php([\w\W]*?)\?>/gi);phpMatches&&(matches=$.merge(matches,phpMatches))}matches&&$.each(matches,function(i,s){html=html.replace(s,"buffer_"+i),buffer.push(s)})}return html=html.replace(/\n/g," "),html=html.replace(/[\t]*/g,""),html=html.replace(/\n\s*\n/g,"\n"),html=html.replace(/^[\s\n]*/g," "),html=html.replace(/[\s\n]*$/g," "),html=html.replace(/>\s{2,}</g,"> <"),html=this.cleanReplacer(html,buffer),html=html.replace(/\n\n/g,"\n")},cleanReplacer:function(html,buffer){return buffer===!1?html:($.each(buffer,function(i,s){html=html.replace("buffer_"+i,s)}),html)},cleanRemoveEmptyTags:function(html){html=html.replace(/<span>([\w\W]*?)<\/span>/gi,"$1"),html=html.replace(/[\u200B-\u200D\uFEFF]/g,"");var etagsInline=["<b>\\s*</b>","<b>&nbsp;</b>","<em>\\s*</em>"],etags=["<pre></pre>","<blockquote>\\s*</blockquote>","<dd></dd>","<dt></dt>","<ul></ul>","<ol></ol>","<li></li>","<table></table>","<tr></tr>","<span>\\s*<span>","<span>&nbsp;<span>","<p>\\s*</p>","<p></p>","<p>&nbsp;</p>","<p>\\s*<br>\\s*</p>","<div>\\s*</div>","<div>\\s*<br>\\s*</div>"];etags=this.opts.removeEmptyTags?etags.concat(etagsInline):etagsInline;for(var len=etags.length,i=0;len>i;++i)html=html.replace(new RegExp(etags[i],"gi"),"");return html},cleanParagraphy:function(html){function R(str,mod,r){return html.replace(new RegExp(str,mod),r)}if(html=$.trim(html),this.opts.linebreaks===!0)return html;if(""===html||"<p></p>"===html)return this.opts.emptyHtml;html+="\n";var safes=[],matches=html.match(/<(table|div|pre|object)(.*?)>([\w\W]*?)<\/(table|div|pre|object)>/gi);null===matches&&(matches=[]);var commentsMatches=html.match(/<!--([\w\W]*?)-->/gi);if(commentsMatches&&(matches=$.merge(matches,commentsMatches)),this.opts.phpTags){var phpMatches=html.match(/<section(.*?)rel="redactor-php-tag">([\w\W]*?)<\/section>/gi);phpMatches&&(matches=$.merge(matches,phpMatches))}matches&&$.each(matches,function(i,s){safes[i]=s,html=html.replace(s,"{replace"+i+"}\n")}),html=html.replace(/<br \/>\s*<br \/>/gi,"\n\n");var blocks="(comment|html|body|head|title|meta|style|script|link|iframe|table|thead|tfoot|caption|col|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|option|form|map|area|blockquote|address|math|style|p|h[1-6]|hr|fieldset|legend|section|article|aside|hgroup|header|footer|nav|figure|figcaption|details|menu|summary)";html=R("(<"+blocks+"[^>]*>)","gi","\n$1"),html=R("(</"+blocks+">)","gi","$1\n\n"),html=R("\r\n","g","\n"),html=R("\r","g","\n"),html=R("/\n\n+/","g","\n\n");var htmls=html.split(new RegExp("\ns*\n","g"),-1);html="";for(var i in htmls)htmls.hasOwnProperty(i)&&(html+=-1==htmls[i].search("{replace")?"<p>"+htmls[i].replace(/^\n+|\n+$/g,"")+"</p>":htmls[i]);return-1!==html.search(/<blockquote/gi)&&$.each(html.match(/<blockquote(.*?)>([\w\W]*?)<\/blockquote>/gi),function(i,s){var str="";str=s.replace("<p>",""),str=str.replace("</p>","<br>"),html=html.replace(s,str)}),html=R("<p>s*</p>","gi",""),html=R("<p>([^<]+)</(div|address|form)>","gi","<p>$1</p></$2>"),html=R("<p>s*(</?"+blocks+"[^>]*>)s*</p>","gi","$1"),html=R("<p>(<li.+?)</p>","gi","$1"),html=R("<p>s*(</?"+blocks+"[^>]*>)","gi","$1"),html=R("(</?"+blocks+"[^>]*>)s*</p>","gi","$1"),html=R("(</?"+blocks+"[^>]*>)s*<br />","gi","$1"),html=R("<br />(s*</?(?:p|li|div|dl|dd|dt|th|pre|td|ul|ol)[^>]*>)","gi","$1"),html=R("\n</p>","gi","</p>"),html=R("<li><p>","gi","<li>"),html=R("</p></li>","gi","</li>"),html=R("</li><p>","gi","</li>"),html=R("<p>	?\n?<p>","gi","<p>"),html=R("</dt><p>","gi","</dt>"),html=R("</dd><p>","gi","</dd>"),html=R("<br></p></blockquote>","gi","</blockquote>"),html=R("<p>	*</p>","gi",""),$.each(safes,function(i,s){html=html.replace("{replace"+i+"}",s)}),$.trim(html)},cleanConvertInlineTags:function(html){var boldTag="strong";"b"===this.opts.boldTag&&(boldTag="b");var italicTag="em";return"i"===this.opts.italicTag&&(italicTag="i"),html=html.replace(/<span style="font-style: italic;">([\w\W]*?)<\/span>/gi,"<"+italicTag+">$1</"+italicTag+">"),html=html.replace(/<span style="font-weight: bold;">([\w\W]*?)<\/span>/gi,"<"+boldTag+">$1</"+boldTag+">"),html="strong"===this.opts.boldTag?html.replace(/<b>([\w\W]*?)<\/b>/gi,"<strong>$1</strong>"):html.replace(/<strong>([\w\W]*?)<\/strong>/gi,"<b>$1</b>"),html="em"===this.opts.italicTag?html.replace(/<i>([\w\W]*?)<\/i>/gi,"<em>$1</em>"):html.replace(/<em>([\w\W]*?)<\/em>/gi,"<i>$1</i>"),html=html.replace(/<strike>([\w\W]*?)<\/strike>/gi,"<del>$1</del>"),/<span(.*?)data-redactor="verified"(.*?)>([\w\W]*?)<\/span>/gi.test(html)||(html=html.replace(/<span(.*?)(?!data-redactor="verified")(.*?)>([\w\W]*?)<\/span>/gi,'<span$1 data-redactor="verified"$2>$3</span>')),html},cleanStripTags:function(html){if(""==html||"undefined"==typeof html)return html;var allowed=!1;this.opts.allowedTags!==!1&&(allowed=!0);var arr=allowed===!0?this.opts.allowedTags:this.opts.deniedTags,tags=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi;return html=html.replace(tags,function($0,$1){return allowed===!0?$.inArray($1.toLowerCase(),arr)>"-1"?$0:"":$.inArray($1.toLowerCase(),arr)>"-1"?"":$0}),html=this.cleanConvertInlineTags(html)},cleanSavePreCode:function(html,encode){var pre=html.match(/<(pre|code)(.*?)>([\w\W]*?)<\/(pre|code)>/gi);return null!==pre&&$.each(pre,$.proxy(function(i,s){var arr=s.match(/<(pre|code)(.*?)>([\w\W]*?)<\/(pre|code)>/i);arr[3]=arr[3].replace(/&nbsp;/g," "),encode!==!1&&(arr[3]=this.cleanEncodeEntities(arr[3])),html=html.replace(s,"<"+arr[1]+arr[2]+">"+arr[3]+"</"+arr[1]+">")},this)),html},cleanEncodeEntities:function(str){return str=String(str).replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"'),String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},cleanUnverified:function(){var $elem=this.$editor.find("li, img, a, b, strong, sub, sup, i, em, u, small, strike, del, span, cite");$elem.not('[data-redactor="verified"]').filter('[style*="font-size"][style*="line-height"]').css("font-size","").css("line-height",""),$elem.not('[data-redactor="verified"]').filter('[style*="background-color: transparent;"][style*="line-height"]').css("background-color","").css("line-height",""),$elem.not('[data-redactor="verified"]').filter('[style*="background-color: transparent;"]').css("background-color",""),$elem.not('[data-redactor="verified"]').css("line-height",""),$.each($elem,$.proxy(function(i,s){this.removeEmptyAttr(s,"style")},this)),this.$editor.find('div[style="text-align: -webkit-auto;"]').contents().unwrap()},cleanHtml:function(code){var i=0,codeLength=code.length,point=0,start=null,end=null,tag="",out="",cont="";for(this.cleanlevel=0;codeLength>i;i++){if(point=i,-1==code.substr(i).indexOf("<"))return out+=code.substr(i),this.cleanFinish(out);for(;codeLength>point&&"<"!=code.charAt(point);)point++;for(i!=point&&(cont=code.substr(i,point-i),cont.match(/^\s{2,}$/g)||("\n"==out.charAt(out.length-1)?out+=this.cleanGetTabs():"\n"==cont.charAt(0)&&(out+="\n"+this.cleanGetTabs(),cont=cont.replace(/^\s+/,"")),out+=cont),cont.match(/\n/)&&(out+="\n"+this.cleanGetTabs())),start=point;codeLength>point&&">"!=code.charAt(point);)point++;tag=code.substr(start,point-start),i=point;var t;if("!--"==tag.substr(1,3)){if(!tag.match(/--$/)){for(;"-->"!=code.substr(point,3);)point++;point+=2,tag=code.substr(start,point-start),i=point}"\n"!=out.charAt(out.length-1)&&(out+="\n"),out+=this.cleanGetTabs(),out+=tag+">\n"}else"!"==tag[1]?out=this.placeTag(tag+">",out):"?"==tag[1]?out+=tag+">\n":(t=tag.match(/^<(script|style|pre)/i))?(t[1]=t[1].toLowerCase(),tag=this.cleanTag(tag),out=this.placeTag(tag,out),end=String(code.substr(i+1)).toLowerCase().indexOf("</"+t[1]),end&&(cont=code.substr(i+1,end),i+=end,out+=cont)):(tag=this.cleanTag(tag),out=this.placeTag(tag,out))}return this.cleanFinish(out)},cleanGetTabs:function(){for(var s="",j=0;j<this.cleanlevel;j++)s+="	";return s},cleanFinish:function(code){return code=code.replace(/\n\s*\n/g,"\n"),code=code.replace(/^[\s\n]*/,""),code=code.replace(/[\s\n]*$/,""),code=code.replace(/<script(.*?)>\n<\/script>/gi,"<script$1></script>"),this.cleanlevel=0,code},cleanTag:function(tag){var tagout="";tag=tag.replace(/\n/g," "),tag=tag.replace(/\s{2,}/g," "),tag=tag.replace(/^\s+|\s+$/g," ");var suffix="";tag.match(/\/$/)&&(suffix="/",tag=tag.replace(/\/+$/,""));for(var m;m=/\s*([^= ]+)(?:=((['"']).*?\3|[^ ]+))?/.exec(tag);)m[2]?tagout+=m[1].toLowerCase()+"="+m[2]:m[1]&&(tagout+=m[1].toLowerCase()),tagout+=" ",tag=tag.substr(m[0].length);return tagout.replace(/\s*$/,"")+suffix+">"},placeTag:function(tag,out){var nl=tag.match(this.cleannewLevel);return(tag.match(this.cleanlineBefore)||nl)&&(out=out.replace(/\s*$/,""),out+="\n"),nl&&"/"==tag.charAt(1)&&this.cleanlevel--,"\n"==out.charAt(out.length-1)&&(out+=this.cleanGetTabs()),nl&&"/"!=tag.charAt(1)&&this.cleanlevel++,out+=tag,(tag.match(this.cleanlineAfter)||tag.match(this.cleannewLevel))&&(out=out.replace(/ *$/,""),out+="\n"),out},alignmentLeft:function(){this.alignmentSet("","JustifyLeft")},alignmentRight:function(){this.alignmentSet("right","JustifyRight")},alignmentCenter:function(){this.alignmentSet("center","JustifyCenter")},alignmentJustify:function(){this.alignmentSet("justify","JustifyFull")},alignmentSet:function(type,cmd){if(this.bufferSet(),this.oldIE())return this.document.execCommand(cmd,!1,!1),!0;this.selectionSave();var block=this.getBlock();if(!block&&this.opts.linebreaks){this.exec("formatBlock","blockquote");var newblock=this.getBlock(),block=$('<div data-tagblock="">').html($(newblock).html());$(newblock).replaceWith(block),$(block).css("text-align",type),this.removeEmptyAttr(block,"style"),""==type&&"undefined"!=typeof $(block).data("tagblock")&&$(block).replaceWith($(block).html())}else{var elements=this.getBlocks();$.each(elements,$.proxy(function(i,elem){var $el=!1;$el=-1!==$.inArray(elem.tagName,this.opts.alignmentTags)?$(elem):$(elem).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0]),$el&&($el.css("text-align",type),this.removeEmptyAttr($el,"style"))},this))}this.selectionRestore(),this.sync()},formatEmpty:function(e){var html=$.trim(this.$editor.html());html=html.replace(/<br\s?\/?>/i,"");var thtml=html.replace(/<p>\s?<\/p>/gi,"");if(""===html||""===thtml){e.preventDefault();var node=$(this.opts.emptyHtml).get(0);this.$editor.html(node),this.focus()}this.sync()},formatBlocks:function(tag){this.bufferSet();var nodes=this.getBlocks();this.selectionSave(),$.each(nodes,$.proxy(function(i,node){"LI"!==node.tagName&&this.formatBlock(tag,node)},this)),this.selectionRestore(),this.sync()},formatBlock:function(tag,block){if(block===!1&&(block=this.getBlock()),block===!1)return this.opts.linebreaks===!0&&this.execCommand("formatblock",tag),!0;var contents="";if("pre"!==tag?contents=$(block).contents():(contents=$(block).html(),""===$.trim(contents)&&(contents='<span id="selection-marker-1"></span>')),"PRE"===block.tagName&&(tag="p"),this.opts.linebreaks===!0&&"p"===tag)$(block).replaceWith($("<div>").append(contents).html()+"<br>");else{var node=$("<"+tag+">").append(contents);$(block).replaceWith(node)}},formatChangeTag:function(fromElement,toTagName,save){save!==!1&&this.selectionSave();var newElement=$("<"+toTagName+"/>");return $(fromElement).replaceWith(function(){return newElement.append($(this).contents())}),save!==!1&&this.selectionRestore(),newElement},formatQuote:function(){if(this.bufferSet(),this.opts.linebreaks===!1){this.selectionSave();var blocks=this.getBlocks();blocks&&$.each(blocks,$.proxy(function(i,s){"BLOCKQUOTE"===s.tagName?this.formatBlock("p",s,!1):"LI"!==s.tagName&&this.formatBlock("blockquote",s,!1)},this)),this.selectionRestore()}else{var block=this.getBlock();if("BLOCKQUOTE"===block.tagName)this.selectionSave(),$(block).replaceWith($(block).html()+"<br>"),this.selectionRestore();else{var wrapper=this.selectionWrap("blockquote"),html=$(wrapper).html(),blocksElemsRemove=["ul","ol","table","tr","tbody","thead","tfoot","dl"];$.each(blocksElemsRemove,function(i,s){html=html.replace(new RegExp("<"+s+"(.*?)>","gi"),""),html=html.replace(new RegExp("</"+s+">","gi"),"")});var blocksElems=this.opts.blockLevelElements;blocksElems.push("td"),$.each(blocksElems,function(i,s){html=html.replace(new RegExp("<"+s+"(.*?)>","gi"),""),html=html.replace(new RegExp("</"+s+">","gi"),"<br>")}),$(wrapper).html(html),this.selectionElement(wrapper);var next=$(wrapper).next();0!=next.size()&&"BR"===next[0].tagName&&next.remove()}}this.sync()},blockRemoveAttr:function(attr,value){var nodes=this.getBlocks();$(nodes).removeAttr(attr),this.sync()},blockSetAttr:function(attr,value){var nodes=this.getBlocks();$(nodes).attr(attr,value),this.sync()},blockRemoveStyle:function(rule){var nodes=this.getBlocks();$(nodes).css(rule,""),this.removeEmptyAttr(nodes,"style"),this.sync()},blockSetStyle:function(rule,value){var nodes=this.getBlocks();$(nodes).css(rule,value),this.sync()},blockRemoveClass:function(className){var nodes=this.getBlocks();$(nodes).removeClass(className),this.removeEmptyAttr(nodes,"class"),this.sync()},blockSetClass:function(className){var nodes=this.getBlocks();$(nodes).addClass(className),this.sync()},inlineRemoveClass:function(className){this.selectionSave(),this.inlineEachNodes(function(node){$(node).removeClass(className),this.removeEmptyAttr(node,"class")}),this.selectionRestore(),this.sync()},inlineSetClass:function(className){var current=this.getCurrent();$(current).hasClass(className)||this.inlineMethods("addClass",className)},inlineRemoveStyle:function(rule){this.selectionSave(),this.inlineEachNodes(function(node){$(node).css(rule,""),this.removeEmptyAttr(node,"style")}),this.selectionRestore(),this.sync()},inlineSetStyle:function(rule,value){this.inlineMethods("css",rule,value)},inlineRemoveAttr:function(attr){this.selectionSave();var range=this.getRange(),node=this.getElement(),nodes=this.getNodes();(range.collapsed||range.startContainer===range.endContainer&&node)&&(nodes=$(node)),$(nodes).removeAttr(attr),this.inlineUnwrapSpan(),this.selectionRestore(),this.sync()},inlineSetAttr:function(attr,value){this.inlineMethods("attr",attr,value)},inlineMethods:function(type,attr,value){this.bufferSet(),this.selectionSave();var range=this.getRange(),el=this.getElement();if(!range.collapsed&&range.startContainer!==range.endContainer||!el||this.nodeTestBlocks(el)){this.document.execCommand("fontSize",!1,4);var fonts=this.$editor.find("font");$.each(fonts,$.proxy(function(i,s){this.inlineSetMethods(type,s,attr,value)},this))}else $(el)[type](attr,value);this.selectionRestore(),this.sync()},inlineSetMethods:function(type,s,attr,value){var el,parent=$(s).parent();return parent&&"SPAN"===parent[0].tagName&&0!=parent[0].attributes.length?(el=parent,$(s).replaceWith($(s).html())):(el=$('<span data-redactor="verified" data-redactor-inlineMethods>').append($(s).contents()),$(s).replaceWith(el)),$(el)[type](attr,value),el},inlineEachNodes:function(callback){var collapsed,range=this.getRange(),node=this.getElement(),nodes=this.getNodes();(range.collapsed||range.startContainer===range.endContainer&&node)&&(nodes=$(node),collapsed=!0),$.each(nodes,$.proxy(function(i,node){if(!collapsed&&"SPAN"!==node.tagName){if("SPAN"!==node.parentNode.tagName||$(node.parentNode).hasClass("redactor_editor"))return;node=node.parentNode}callback.call(this,node)},this))},inlineUnwrapSpan:function(){var $spans=this.$editor.find("span[data-redactor-inlineMethods]");$.each($spans,$.proxy(function(i,span){var $span=$(span);void 0===$span.attr("class")&&void 0===$span.attr("style")&&$span.contents().unwrap()},this))},inlineFormat:function(tag){this.selectionSave(),this.document.execCommand("fontSize",!1,4);var last,fonts=this.$editor.find("font");$.each(fonts,function(i,s){var el=$("<"+tag+"/>").append($(s).contents());$(s).replaceWith(el),last=el}),this.selectionRestore(),this.sync()},inlineRemoveFormat:function(tag){this.selectionSave();var utag=tag.toUpperCase(),nodes=this.getNodes(),parent=$(this.getParent()).parent();$.each(nodes,function(i,s){s.tagName===utag&&this.inlineRemoveFormatReplace(s)}),parent&&parent[0].tagName===utag&&this.inlineRemoveFormatReplace(parent),this.selectionRestore(),this.sync()},inlineRemoveFormatReplace:function(el){$(el).replaceWith($(el).contents())},insertHtml:function(html,sync){var current=this.getCurrent(),parent=current.parentNode;this.$editor.focus(),this.bufferSet();var $html=$("<div>").append($.parseHTML(html));html=$html.html(),html=this.cleanRemoveEmptyTags(html),$html=$("<div>").append($.parseHTML(html));
var currBlock=this.getBlock();if(1==$html.contents().length){var htmlTagName=$html.contents()[0].tagName;("P"!=htmlTagName&&htmlTagName==currBlock.tagName||"PRE"==htmlTagName)&&(html=$html.text(),$html=$("<div>").append(html))}!this.opts.linebreaks&&1==$html.contents().length&&3==$html.contents()[0].nodeType&&(this.getRangeSelectedNodes().length>2||!current||"BODY"==current.tagName&&!parent||"HTML"==parent.tagName)&&(html="<p>"+html+"</p>"),$html.contents().length>1&&currBlock||$html.contents().is("p, :header, ul, ol, div, table, blockquote, pre, address, section, header, footer, aside, article")?this.browser("msie")?this.document.selection.createRange().pasteHTML(html):this.document.execCommand("inserthtml",!1,html):this.insertHtmlAdvanced(html,!1),this.selectall&&this.window.setTimeout($.proxy(function(){this.opts.linebreaks?this.focusEnd():this.selectionEnd(this.$editor.contents().last())},this),1),this.observeStart(),sync!==!1&&this.sync()},insertHtmlAdvanced:function(html,sync){var sel=this.getSelection();if(sel.getRangeAt&&sel.rangeCount){var range=sel.getRangeAt(0);range.deleteContents();var el=this.document.createElement("div");el.innerHTML=html;for(var node,lastNode,frag=this.document.createDocumentFragment();node=el.firstChild;)lastNode=frag.appendChild(node);range.insertNode(frag),lastNode&&(range=range.cloneRange(),range.setStartAfter(lastNode),range.collapse(!0),sel.removeAllRanges(),sel.addRange(range))}sync!==!1&&this.sync()},insertText:function(html){var $html=$($.parseHTML(html));$html.length&&(html=$html.text()),this.$editor.focus(),this.browser("msie")?this.document.selection.createRange().pasteHTML(html):this.document.execCommand("inserthtml",!1,html),this.sync()},insertNode:function(node){node=node[0]||node;var sel=this.getSelection();sel.getRangeAt&&sel.rangeCount&&(range=sel.getRangeAt(0),range.deleteContents(),range.insertNode(node),range.setEndAfter(node),range.setStartAfter(node),sel.removeAllRanges(),sel.addRange(range))},insertNodeToCaretPositionFromPoint:function(e,node){var range,x=e.clientX,y=e.clientY;if(this.document.caretPositionFromPoint){var pos=this.document.caretPositionFromPoint(x,y);range=this.getRange(),range.setStart(pos.offsetNode,pos.offset),range.collapse(!0),range.insertNode(node)}else if(this.document.caretRangeFromPoint)range=this.document.caretRangeFromPoint(x,y),range.insertNode(node);else if("undefined"!=typeof document.body.createTextRange){range=this.document.body.createTextRange(),range.moveToPoint(x,y);var endRange=range.duplicate();endRange.moveToPoint(x,y),range.setEndPoint("EndToEnd",endRange),range.select()}},insertAfterLastElement:function(element){if(this.isEndOfElement()){if($($.trim(this.$editor.html())).get(0)!=$.trim(element)&&this.$editor.contents().last()[0]!==element)return!1;if(this.bufferSet(),this.opts.linebreaks===!1){var node=$(this.opts.emptyHtml);$(element).after(node),this.selectionStart(node)}else{var node=$('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>",this.document)[0];$(element).after(node),$(node).after(this.opts.invisibleSpace),this.selectionRestore()}}},insertLineBreak:function(){this.selectionSave(),this.$editor.find("#selection-marker-1").before("<br>"+(this.browser("webkit")?this.opts.invisibleSpace:"")),this.selectionRestore()},insertDoubleLineBreak:function(){this.selectionSave(),this.$editor.find("#selection-marker-1").before("<br><br>"+(this.browser("webkit")?this.opts.invisibleSpace:"")),this.selectionRestore()},replaceLineBreak:function(element){var node=$("<br>"+this.opts.invisibleSpace);$(element).replaceWith(node),this.selectionStart(node)},pasteClean:function(html){if(html=this.callback("pasteBefore",!1,html),this.opts.pastePlainText){var tmp=this.document.createElement("div");return html=html.replace(/<br>|<\/H[1-6]>|<\/p>|<\/div>/gi,"\n"),tmp.innerHTML=html,html=tmp.textContent||tmp.innerText,html=html.replace("\n","<br>"),html=this.cleanParagraphy(html),this.pasteInsert(html),!1}if(this.currentOrParentIs("PRE"))return html=this.pastePre(html),this.pasteInsert(html),!0;if(html=html.replace(/<p(.*?)class="MsoListParagraphCxSpFirst"([\w\W]*?)<\/p>/gi,"<ul><p$2</p>"),html=html.replace(/<p(.*?)class="MsoListParagraphCxSpLast"([\w\W]*?)<\/p>/gi,"<p$2</p></ul>"),html=html.replace(/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi,""),html=html.replace(/(&nbsp;){2,}/gi,"&nbsp;"),html=html.replace(/&nbsp;/gi," "),html=html.replace(/<b\sid="internal-source-marker(.*?)">([\w\W]*?)<\/b>/gi,"$2"),html=html.replace(/<b(.*?)id="docs-internal-guid(.*?)">([\w\W]*?)<\/b>/gi,"$3"),html=this.cleanStripTags(html),html=html.replace(/<td><\/td>/gi,"[td]"),html=html.replace(/<td>&nbsp;<\/td>/gi,"[td]"),html=html.replace(/<td><br><\/td>/gi,"[td]"),html=html.replace(/<a(.*?)href="(.*?)"(.*?)>([\w\W]*?)<\/a>/gi,'[a href="$2"]$4[/a]'),html=html.replace(/<iframe(.*?)>([\w\W]*?)<\/iframe>/gi,"[iframe$1]$2[/iframe]"),html=html.replace(/<video(.*?)>([\w\W]*?)<\/video>/gi,"[video$1]$2[/video]"),html=html.replace(/<audio(.*?)>([\w\W]*?)<\/audio>/gi,"[audio$1]$2[/audio]"),html=html.replace(/<embed(.*?)>([\w\W]*?)<\/embed>/gi,"[embed$1]$2[/embed]"),html=html.replace(/<object(.*?)>([\w\W]*?)<\/object>/gi,"[object$1]$2[/object]"),html=html.replace(/<param(.*?)>/gi,"[param$1]"),html=html.replace(/<img(.*?)style="(.*?)"(.*?)>/gi,"[img$1$3]"),html=html.replace(/<img(.*?)>/gi,"[img$1]"),html=html.replace(/ class="(.*?)"/gi,""),html=html.replace(/<(\w+)([\w\W]*?)>/gi,"<$1>"),html=html.replace(/<[^\/>][^>]*>(\s*|\t*|\n*|&nbsp;|<br>)<\/[^>]+>/gi,""),html=html.replace(/<div>\s*?\t*?\n*?(<ul>|<ol>|<p>)/gi,"$1"),html=html.replace(/\[td\]/gi,"<td>&nbsp;</td>"),html=html.replace(/\[a href="(.*?)"\]([\w\W]*?)\[\/a\]/gi,'<a href="$1">$2</a>'),html=html.replace(/\[iframe(.*?)\]([\w\W]*?)\[\/iframe\]/gi,"<iframe$1>$2</iframe>"),html=html.replace(/\[video(.*?)\]([\w\W]*?)\[\/video\]/gi,"<video$1>$2</video>"),html=html.replace(/\[audio(.*?)\]([\w\W]*?)\[\/audio\]/gi,"<audio$1>$2</audio>"),html=html.replace(/\[embed(.*?)\]([\w\W]*?)\[\/embed\]/gi,"<embed$1>$2</embed>"),html=html.replace(/\[object(.*?)\]([\w\W]*?)\[\/object\]/gi,"<object$1>$2</object>"),html=html.replace(/\[param(.*?)\]/gi,"<param$1>"),html=html.replace(/\[img(.*?)\]/gi,"<img$1>"),this.opts.convertDivs&&(html=html.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,"<p>$2</p>"),html=html.replace(/<\/div><p>/gi,"<p>"),html=html.replace(/<\/p><\/div>/gi,"</p>")),html=this.currentOrParentIs("LI")?html.replace(/<p>([\w\W]*?)<\/p>/gi,"$1<br>"):this.cleanParagraphy(html),html=html.replace(/<span(.*?)>([\w\W]*?)<\/span>/gi,"$2"),html=html.replace(/<img>/gi,""),html=html.replace(/<[^\/>][^>][^img|param|source]*>(\s*|\t*|\n*|&nbsp;|<br>)<\/[^>]+>/gi,""),html=html.replace(/\n{3,}/gi,"\n"),html=html.replace(/<p><p>/gi,"<p>"),html=html.replace(/<\/p><\/p>/gi,"</p>"),html=html.replace(/<li>(\s*|\t*|\n*)<p>/gi,"<li>"),html=html.replace(/<\/p>(\s*|\t*|\n*)<\/li>/gi,"</li>"),this.opts.linebreaks===!0&&(html=html.replace(/<p(.*?)>([\w\W]*?)<\/p>/gi,"$2<br>")),html=html.replace(/<[^\/>][^>][^img|param|source]*>(\s*|\t*|\n*|&nbsp;|<br>)<\/[^>]+>/gi,""),html=html.replace(/<img src="webkit-fake-url\:\/\/(.*?)"(.*?)>/gi,""),this.pasteClipboardMozilla=!1,this.browser("mozilla")){if(this.opts.clipboardUpload){var matches=html.match(/<img src="data:image(.*?)"(.*?)>/gi);if(null!==matches){this.pasteClipboardMozilla=matches;for(k in matches){var img=matches[k].replace("<img",'<img data-mozilla-paste-image="'+k+'" ');html=html.replace(matches[k],img)}}}for(;/<br>$/gi.test(html);)html=html.replace(/<br>$/gi,"")}for(html=html.replace(/<p>([\w\W]*?)<\/p>/gi,"<li>$1</li>");/<font>([\w\W]*?)<\/font>/gi.test(html);)html=html.replace(/<font>([\w\W]*?)<\/font>/gi,"$1");this.pasteInsert(html)},pastePre:function(s){s=s.replace(/<br>|<\/H[1-6]>|<\/p>|<\/div>/gi,"\n");var tmp=this.document.createElement("div");return tmp.innerHTML=s,this.cleanEncodeEntities(tmp.textContent||tmp.innerText)},pasteInsert:function(html){this.selectall&&(this.opts.linebreaks?this.$editor.html(""):this.$editor.html(this.opts.emptyHtml),this.$editor.focus()),html=this.callback("pasteAfter",!1,html),this.insertHtml(html),this.selectall=!1,setTimeout($.proxy(function(){rtePaste=!1,this.browser("mozilla")&&this.$editor.find("p:empty").remove(),this.pasteClipboardMozilla!==!1&&this.pasteClipboardUploadMozilla()},this),100),this.opts.autoresize?$(this.document.body).scrollTop(this.saveScroll):this.$editor.scrollTop(this.saveScroll)},pasteClipboardUploadMozilla:function(){var imgs=this.$editor.find("img[data-mozilla-paste-image]");$.each(imgs,$.proxy(function(i,s){var $s=$(s),arr=s.src.split(","),data=arr[1],contentType=arr[0].split(";")[0].split(":")[1];$.post(this.opts.clipboardUploadUrl,{contentType:contentType,data:data},$.proxy(function(data){var json=$.parseJSON(data);$s.attr("src",json.filelink),$s.removeAttr("data-mozilla-paste-image"),this.sync(),this.callback("imageUpload",$s,json)},this))},this))},pasteClipboardUpload:function(e){var result=e.target.result,arr=result.split(","),data=arr[1],contentType=arr[0].split(";")[0].split(":")[1];this.opts.clipboardUpload?$.post(this.opts.clipboardUploadUrl,{contentType:contentType,data:data},$.proxy(function(data){var json=$.parseJSON(data),html='<img src="'+json.filelink+'" id="clipboard-image-marker" />';this.execCommand("inserthtml",html,!1);var image=$(this.$editor.find("img#clipboard-image-marker"));image.length?image.removeAttr("id"):image=!1,this.sync(),image&&this.callback("imageUpload",image,json)},this)):this.insertHtml('<img src="'+result+'" />')},bufferSet:function(html){void 0!==html?this.opts.buffer.push(html):(this.selectionSave(),this.opts.buffer.push(this.$editor.html()),this.selectionRemoveMarkers("buffer"))},bufferUndo:function(){return 0===this.opts.buffer.length?void this.$editor.focus():(this.selectionSave(),this.opts.rebuffer.push(this.$editor.html()),this.selectionRestore(!1,!0),this.$editor.html(this.opts.buffer.pop()),this.selectionRestore(),void setTimeout($.proxy(this.observeStart,this),100))},bufferRedo:function(){return 0===this.opts.rebuffer.length?(this.$editor.focus(),!1):(this.selectionSave(),this.opts.buffer.push(this.$editor.html()),this.selectionRestore(!1,!0),this.$editor.html(this.opts.rebuffer.pop()),this.selectionRestore(!0),void setTimeout($.proxy(this.observeStart,this),4))},observeStart:function(){this.observeImages(),this.observeTables(),this.opts.observeLinks&&this.observeLinks()},observeLinks:function(){this.$editor.find("a").on("click",$.proxy(this.linkObserver,this)),this.$editor.on("click.redactor",$.proxy(function(e){this.linkObserverTooltipClose(e)},this))},observeTables:function(){this.$editor.find("table").on("click",$.proxy(this.tableObserver,this))},observeImages:function(){return this.opts.observeImages===!1?!1:void this.$editor.find("img").each($.proxy(function(i,elem){this.browser("msie")&&$(elem).attr("unselectable","on"),this.imageResize(elem)},this))},linkObserver:function(e){var $link=$(e.target),pos=$link.offset(),tooltip=$('<span class="redactor-link-tooltip"></span>'),href=$link.attr("href");href.length>24&&(href=href.substring(0,24)+"...");var aLink=$('<a href="'+$link.attr("href")+'" target="_blank">'+href+"</a>").on("click",$.proxy(function(e){this.linkObserverTooltipClose(!1)},this)),aEdit=$('<a href="#">'+this.opts.curLang.edit+"</a>").on("click",$.proxy(function(e){e.preventDefault(),this.linkShow(),this.linkObserverTooltipClose(!1)},this)),aUnlink=$('<a href="#">'+this.opts.curLang.unlink+"</a>").on("click",$.proxy(function(e){e.preventDefault(),this.execCommand("unlink"),this.linkObserverTooltipClose(!1)},this));tooltip.append(aLink),tooltip.append(" | "),tooltip.append(aEdit),tooltip.append(" | "),tooltip.append(aUnlink),tooltip.css({top:pos.top+20+"px",left:pos.left+"px"}),$(".redactor-link-tooltip").remove(),$("body").append(tooltip)},linkObserverTooltipClose:function(e){return e!==!1&&"A"==e.target.tagName?!1:void $(".redactor-link-tooltip").remove()},getSelection:function(){return this.opts.rangy?this.opts.iframe?rangy.getSelection(this.$frame[0]):rangy.getSelection():this.document.getSelection()},getRange:function(){if(this.opts.rangy)return this.opts.iframe?rangy.createRange(this.iframeDoc()):rangy.createRange();if(this.document.getSelection){var sel=this.document.getSelection();if(sel.getRangeAt&&sel.rangeCount)return sel.getRangeAt(0)}return this.document.createRange()},selectionElement:function(node){this.setCaret(node)},selectionStart:function(node){this.selectionSet(node[0]||node,0,null,0)},selectionEnd:function(node){this.selectionSet(node[0]||node,1,null,1)},selectionSet:function(orgn,orgo,focn,foco){null==focn&&(focn=orgn),null==foco&&(foco=orgo);var sel=this.getSelection();if(sel){var range=this.getRange();range.setStart(orgn,orgo),range.setEnd(focn,foco);try{sel.removeAllRanges()}catch(e){}sel.addRange(range)}},selectionWrap:function(tag){tag=tag.toLowerCase();var block=this.getBlock();if(block){var wrapper=this.formatChangeTag(block,tag);return this.sync(),wrapper}var sel=this.getSelection(),range=sel.getRangeAt(0),wrapper=document.createElement(tag);return wrapper.appendChild(range.extractContents()),range.insertNode(wrapper),this.selectionElement(wrapper),wrapper},selectionAll:function(){var range=this.getRange();range.selectNodeContents(this.$editor[0]);var sel=this.getSelection();sel.removeAllRanges(),sel.addRange(range)},selectionRemove:function(){this.getSelection().removeAllRanges()},getCaretOffset:function(element){var caretOffset=0,range=this.getRange(),preCaretRange=range.cloneRange();return preCaretRange.selectNodeContents(element),preCaretRange.setEnd(range.endContainer,range.endOffset),caretOffset=$.trim(preCaretRange.toString()).length},getCaretOffsetRange:function(){return new Range(this.getSelection().getRangeAt(0))},setCaret:function(el,start,end){"undefined"==typeof end&&(end=start),el=el[0]||el;var range=this.getRange();range.selectNodeContents(el);var endCharCount,textNodes=this.getTextNodesIn(el),foundStart=!1,charCount=0;if(1==textNodes.length&&start)range.setStart(textNodes[0],start),range.setEnd(textNodes[0],end);else for(var textNode,i=0;textNode=textNodes[i++];){if(endCharCount=charCount+textNode.length,!foundStart&&start>=charCount&&(endCharCount>start||start==endCharCount&&i<textNodes.length)&&(range.setStart(textNode,start-charCount),foundStart=!0),foundStart&&endCharCount>=end){range.setEnd(textNode,end-charCount);break}charCount=endCharCount}var sel=this.getSelection();sel.removeAllRanges(),sel.addRange(range)},getTextNodesIn:function(node){var textNodes=[];if(3==node.nodeType)textNodes.push(node);else for(var children=node.childNodes,i=0,len=children.length;len>i;++i)textNodes.push.apply(textNodes,this.getTextNodesIn(children[i]));return textNodes},selectionSave:function(){this.isFocused()||this.$editor.focus(),this.opts.rangy?this.savedSel=rangy.saveSelection():this.selectionCreateMarker(this.getRange())},selectionCreateMarker:function(range,remove){if(range){var node1=$('<span id="selection-marker-1" class="redactor-selection-marker">'+this.opts.invisibleSpace+"</span>",this.document)[0],node2=$('<span id="selection-marker-2" class="redactor-selection-marker">'+this.opts.invisibleSpace+"</span>",this.document)[0];range.collapsed===!0?this.selectionSetMarker(range,node1,!0):(this.selectionSetMarker(range,node1,!0),this.selectionSetMarker(range,node2,!1)),this.savedSel=this.$editor.html(),this.selectionRestore(!1,!1)}},selectionSetMarker:function(range,node,type){var boundaryRange=range.cloneRange();boundaryRange.collapse(type),boundaryRange.insertNode(node),boundaryRange.detach()},selectionRestore:function(replace,remove){if(this.opts.rangy)rangy.restoreSelection(this.savedSel);else{replace===!0&&this.savedSel&&this.$editor.html(this.savedSel);var node1=this.$editor.find("span#selection-marker-1"),node2=this.$editor.find("span#selection-marker-2");this.browser("mozilla")?this.$editor.focus():this.isFocused()||this.$editor.focus(),0!=node1.length&&0!=node2.length?this.selectionSet(node1[0],0,node2[0],0):0!=node1.length&&this.selectionSet(node1[0],0,null,0),remove!==!1&&(this.selectionRemoveMarkers(),this.savedSel=!1)}},selectionRemoveMarkers:function(type){this.opts.rangy?rangy.removeMarkers(this.savedSel):$.each(this.$editor.find("span.redactor-selection-marker"),function(){var html=$.trim($(this).html().replace(/[^\u0000-\u1C7F]/g,""));""==html?$(this).remove():$(this).removeAttr("class").removeAttr("id")})},getCurrent:function(){var el=!1,sel=this.getSelection();return sel.rangeCount>0&&(el=sel.getRangeAt(0).startContainer),this.isParentRedactor(el)},getParent:function(elem){return elem=elem||this.getCurrent(),elem?this.isParentRedactor($(elem).parent()[0]):!1},getBlock:function(node){for("undefined"==typeof node&&(node=this.getCurrent());node;){if(this.nodeTestBlocks(node))return $(node).hasClass("redactor_editor")?!1:node;node=node.parentNode}return!1},getBlocks:function(nodes){var newnodes=[];if("undefined"==typeof nodes){var range=this.getRange();if(range&&range.collapsed===!0)return[this.getBlock()];var nodes=this.getNodes(range)}return $.each(nodes,$.proxy(function(i,node){return this.opts.iframe===!1&&0==$(node).parents("div.redactor_editor").size()?!1:void(this.nodeTestBlocks(node)&&newnodes.push(node))},this)),0===newnodes.length&&(newnodes=[this.getBlock()]),newnodes},nodeTestBlocks:function(node){return 1==node.nodeType&&this.rTestBlock.test(node.nodeName)},tagTestBlock:function(tag){return this.rTestBlock.test(tag)},getSelectedNodes:function(range){if("undefined"==typeof range||0==range)var range=this.getRange();if(range&&range.collapsed===!0)return[this.getCurrent()];var sel=this.getSelection();try{var frag=sel.getRangeAt(0).cloneContents()}catch(e){return!1}var tempspan=this.document.createElement("span");tempspan.appendChild(frag),window.selnodes=tempspan.childNodes;for(var len=selnodes.length,output=[],i=0,u=len;u>i;i++)output.push(selnodes[i]);return 0==output.length&&output.push(this.getCurrent()),output},getNodes:function(range,tag){if(this.opts.linebreaks)return this.getSelectedNodes(range);if("undefined"==typeof range||0==range)var range=this.getRange();if(range&&range.collapsed===!0){if("undefined"==typeof tag&&this.tagTestBlock(tag)){var block=this.getBlock();return block.tagName==tag?[block]:[]}return[this.getCurrent()]}var nodes=[],finalnodes=[],sel=this.document.getSelection();if(sel.isCollapsed||(nodes=this.getRangeSelectedNodes(sel.getRangeAt(0))),$.each(nodes,$.proxy(function(i,node){return this.opts.iframe===!1&&0==$(node).parents("div.redactor_editor").size()?!1:void("undefined"==typeof tag?""!=$.trim(node.textContent)&&finalnodes.push(node):node.tagName==tag&&finalnodes.push(node))},this)),0==finalnodes.length){if("undefined"==typeof tag&&this.tagTestBlock(tag)){var block=this.getBlock();return block.tagName==tag?finalnodes.push(block):[]}finalnodes.push(this.getCurrent())}return finalnodes},getElement:function(node){for(node||(node=this.getCurrent());node;){if(1==node.nodeType)return $(node).hasClass("redactor_editor")?!1:node;node=node.parentNode}return!1},getRangeSelectedNodes:function(range){range=range||this.getRange();var node=range.startContainer,endNode=range.endContainer;if(node==endNode)return[node];for(var rangeNodes=[];node&&node!=endNode;)rangeNodes.push(node=this.nextNode(node));for(node=range.startContainer;node&&node!=range.commonAncestorContainer;)rangeNodes.unshift(node),node=node.parentNode;return rangeNodes},nextNode:function(node){if(node.hasChildNodes())return node.firstChild;for(;node&&!node.nextSibling;)node=node.parentNode;return node?node.nextSibling:null},getSelectionText:function(){return this.getSelection().toString()},getSelectionHtml:function(){var html="",sel=this.getSelection();if(sel.rangeCount){for(var container=this.document.createElement("div"),len=sel.rangeCount,i=0;len>i;++i)container.appendChild(sel.getRangeAt(i).cloneContents());html=container.innerHTML}return this.syncClean(html)},tableShow:function(){this.selectionSave(),this.modalInit(this.opts.curLang.table,this.opts.modal_table,300,$.proxy(function(){$("#redactor_insert_table_btn").click($.proxy(this.tableInsert,this)),setTimeout(function(){$("#redactor_table_rows").focus()},200)},this))},tableInsert:function(){var i,$row,z,$column,rows=$("#redactor_table_rows").val(),columns=$("#redactor_table_columns").val(),$table_box=$("<div></div>"),tableId=Math.floor(99999*Math.random()),$table=$('<table id="table'+tableId+'"><tbody></tbody></table>');for(i=0;rows>i;i++){for($row=$("<tr></tr>"),z=0;columns>z;z++)$column=$("<td>"+this.opts.invisibleSpace+"</td>"),0===i&&0===z&&$column.append('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>"),$($row).append($column);$table.append($row)}$table_box.append($table);var html=$table_box.html();this.modalClose(),this.selectionRestore();var current=this.getBlock()||this.getCurrent();current&&"BODY"!=current.tagName?$(current).after(html):this.insertHtmlAdvanced(html,!1),this.selectionRestore();var table=this.$editor.find("#table"+tableId);this.tableObserver(table),this.buttonActiveObserver(),table.find("span#selection-marker-1").remove(),table.removeAttr("id"),this.sync()},tableObserver:function(e){this.$table=$(e.target||e).closest("table"),this.$tbody=$(e.target).closest("tbody"),this.$thead=this.$table.find("thead"),this.$current_td=$(e.target||this.$table.find("td").first()),this.$current_tr=$(e.target||this.$table.find("tr").first()).closest("tr")},tableDeleteTable:function(){this.bufferSet(),this.$table&&(this.$table.remove(),this.$table=!1,this.sync())},tableDeleteRow:function(){if(this.bufferSet(),this.$current_tr){var $focusTR=this.$current_tr.prev().length?this.$current_tr.prev():this.$current_tr.next();if($focusTR.length){var $focusTD=$focusTR.children("td").first();$focusTD.length&&($focusTD.prepend('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>"),this.selectionRestore())}this.$current_tr.remove(),this.sync()}},tableDeleteColumn:function(){this.bufferSet();var index=this.$current_td.get(0).cellIndex;this.$table.find("tr").each($.proxy(function(i,elem){var focusIndex=0>index-1?index+1:index-1;0===i&&($(elem).find("td").eq(focusIndex).prepend('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>"),this.selectionRestore()),$(elem).find("td").eq(index).remove()},this)),this.sync()},tableAddHead:function(){if(this.bufferSet(),0!==this.$table.find("thead").size())this.tableDeleteHead();else{var tr=this.$table.find("tr").first().clone();tr.find("td").html(this.opts.invisibleSpace),this.$thead=$("<thead></thead>"),this.$thead.append(tr),this.$table.prepend(this.$thead),this.sync()}},tableDeleteHead:function(){this.bufferSet(),$(this.$thead).remove(),this.$thead=!1,this.sync()},tableAddRowAbove:function(){this.tableAddRow("before")},tableAddRowBelow:function(){this.tableAddRow("after")},tableAddColumnLeft:function(){this.tableAddColumn("before")},tableAddColumnRight:function(){this.tableAddColumn("after")},tableAddRow:function(type){this.bufferSet();var new_tr=this.$current_tr.clone();new_tr.find("td").html(this.opts.invisibleSpace),"after"===type?this.$current_tr.after(new_tr):this.$current_tr.before(new_tr),this.sync()},tableAddColumn:function(type){this.bufferSet();var index=0;this.$current_tr.find("td").each($.proxy(function(i,elem){$(elem)[0]===this.$current_td[0]&&(index=i)},this)),this.$table.find("tr").each($.proxy(function(i,elem){var $current=$(elem).find("td").eq(index),td=$current.clone();td.html(this.opts.invisibleSpace),"after"===type?$current.after(td):$current.before(td)},this)),this.sync()},videoShow:function(){this.selectionSave(),this.modalInit(this.opts.curLang.video,this.opts.modal_video,600,$.proxy(function(){$("#redactor_insert_video_btn").click($.proxy(this.videoInsert,this)),setTimeout(function(){$("#redactor_insert_video_area").focus()},200)},this))},videoInsert:function(){var data=$("#redactor_insert_video_area").val();data=this.cleanStripTags(data),this.selectionRestore();var current=this.getBlock()||this.getCurrent();current?$(current).after(data):this.insertHtmlAdvanced(data,!1),this.sync(),this.modalClose()},linkShow:function(){this.selectionSave();var callback=$.proxy(function(){this.insert_link_node=!1;var sel=this.getSelection(),url="",text="",target="",elem=this.getParent(),par=$(elem).parent().get(0);par&&"A"===par.tagName&&(elem=par),elem&&"A"===elem.tagName?(url=elem.href,text=$(elem).text(),target=elem.target,this.insert_link_node=elem):text=sel.toString(),$(".redactor_link_text").val(text);var thref=self.location.href.replace(/\/$/i,""),turl=url.replace(thref,"");if(this.opts.linkProtocol===!1){var re=new RegExp("^(http|ftp|https)://"+self.location.host,"i");turl=turl.replace(re,"")}var tabs=$("#redactor_tabs").find("a");this.opts.linkEmail===!1&&tabs.eq(1).remove(),this.opts.linkAnchor===!1&&tabs.eq(2).remove(),this.opts.linkEmail===!1&&this.opts.linkAnchor===!1?($("#redactor_tabs").remove(),$("#redactor_link_url").val(turl)):0===url.search("mailto:")?(this.modalSetTab.call(this,2),$("#redactor_tab_selected").val(2),$("#redactor_link_mailto").val(url.replace("mailto:",""))):0===turl.search(/^#/gi)?(this.modalSetTab.call(this,3),$("#redactor_tab_selected").val(3),$("#redactor_link_anchor").val(turl.replace(/^#/gi,""))):$("#redactor_link_url").val(turl),"_blank"===target&&$("#redactor_link_blank").prop("checked",!0),$("#redactor_insert_link_btn").click($.proxy(this.linkProcess,this)),setTimeout(function(){$("#redactor_link_url").focus()},200)},this);this.modalInit(this.opts.curLang.link,this.opts.modal_link,460,callback)},linkProcess:function(){var tab_selected=$("#redactor_tab_selected").val(),link="",text="",target="",targetBlank="";if("1"===tab_selected){link=$("#redactor_link_url").val(),text=$("#redactor_link_url_text").val(),$("#redactor_link_blank").prop("checked")&&(target=' target="_blank"',targetBlank="_blank");var pattern="((xn--)?[a-z0-9]+(-[a-z0-9]+)*.)+[a-z]{2,}",re=new RegExp("^(http|ftp|https)://"+pattern,"i"),re2=new RegExp("^"+pattern,"i");-1==link.search(re)&&0==link.search(re2)&&this.opts.linkProtocol&&(link=this.opts.linkProtocol+link)}else"2"===tab_selected?(link="mailto:"+$("#redactor_link_mailto").val(),text=$("#redactor_link_mailto_text").val()):"3"===tab_selected&&(link="#"+$("#redactor_link_anchor").val(),text=$("#redactor_link_anchor_text").val());text=text.replace(/<|>/g,""),this.linkInsert('<a href="'+link+'"'+target+">"+text+"</a>",$.trim(text),link,targetBlank)},linkInsert:function(a,text,link,target){this.selectionRestore(),""!==text&&(this.insert_link_node?(this.bufferSet(),$(this.insert_link_node).text(text).attr("href",link),""!==target?$(this.insert_link_node).attr("target",target):$(this.insert_link_node).removeAttr("target"),this.sync()):this.exec("inserthtml",a)),this.modalClose()},fileShow:function(){this.selectionSave();var callback=$.proxy(function(){var sel=this.getSelection(),text="";text=this.oldIE()?sel.text:sel.toString(),$("#redactor_filename").val(text),this.isMobile()||this.draguploadInit("#redactor_file",{url:this.opts.fileUpload,uploadFields:this.opts.uploadFields,success:$.proxy(this.fileCallback,this),error:$.proxy(function(obj,json){this.callback("fileUploadError",json)},this)}),this.uploadInit("redactor_file",{auto:!0,url:this.opts.fileUpload,success:$.proxy(this.fileCallback,this),error:$.proxy(function(obj,json){this.callback("fileUploadError",json)},this)})},this);this.modalInit(this.opts.curLang.file,this.opts.modal_file,500,callback)},fileCallback:function(json){if(this.selectionRestore(),json!==!1){var text=$("#redactor_filename").val();""===text&&(text=json.filename);var link='<a href="'+json.filelink+'" id="filelink-marker">'+text+"</a>";this.browser("webkit")&&this.window.chrome&&(link+="&nbsp;"),this.execCommand("inserthtml",link,!1);var linkmarker=$(this.$editor.find("a#filelink-marker"));0!=linkmarker.size()?linkmarker.removeAttr("id"):linkmarker=!1,this.sync(),this.callback("fileUpload",linkmarker,json)}this.modalClose()},imageShow:function(){this.selectionSave();var callback=$.proxy(function(){if(this.opts.imageGetJson?$.getJSON(this.opts.imageGetJson,$.proxy(function(data){var folders={},count=0;$.each(data,$.proxy(function(key,val){"undefined"!=typeof val.folder&&(count++,folders[val.folder]=count)},this));var folderclass=!1;if($.each(data,$.proxy(function(key,val){var thumbtitle="";"undefined"!=typeof val.title&&(thumbtitle=val.title);var folderkey=0;$.isEmptyObject(folders)||"undefined"==typeof val.folder||(folderkey=folders[val.folder],folderclass===!1&&(folderclass=".redactorfolder"+folderkey));var img=$('<img src="'+val.thumb+'" class="redactorfolder redactorfolder'+folderkey+'" rel="'+val.image+'" title="'+thumbtitle+'" />');$("#redactor_image_box").append(img),$(img).click($.proxy(this.imageThumbClick,this))},this)),!$.isEmptyObject(folders)){$(".redactorfolder").hide(),$(folderclass).show();var onchangeFunc=function(e){$(".redactorfolder").hide(),$(".redactorfolder"+$(e.target).val()).show()},select=$('<select id="redactor_image_box_select">');$.each(folders,function(k,v){select.append($('<option value="'+v+'">'+k+"</option>"))}),$("#redactor_image_box").before(select),select.change(onchangeFunc)}},this)):$("#redactor_tabs").find("a").eq(1).remove(),this.opts.imageUpload||this.opts.s3)this.isMobile()||this.opts.s3!==!1||$("#redactor_file").length&&this.draguploadInit("#redactor_file",{url:this.opts.imageUpload,uploadFields:this.opts.uploadFields,success:$.proxy(this.imageCallback,this),error:$.proxy(function(obj,json){this.callback("imageUploadError",json)},this)}),this.opts.s3===!1?this.uploadInit("redactor_file",{auto:!0,url:this.opts.imageUpload,success:$.proxy(this.imageCallback,this),error:$.proxy(function(obj,json){this.callback("imageUploadError",json)},this)}):$("#redactor_file").on("change.redactor",$.proxy(this.s3handleFileSelect,this));else if($(".redactor_tab").hide(),this.opts.imageGetJson){var tabs=$("#redactor_tabs").find("a");tabs.eq(0).remove(),tabs.eq(1).addClass("redactor_tabs_act"),$("#redactor_tab2").show()}else $("#redactor_tabs").remove(),$("#redactor_tab3").show();$("#redactor_upload_btn").click($.proxy(this.imageCallbackLink,this)),this.opts.imageUpload||this.opts.imageGetJson||setTimeout(function(){$("#redactor_file_link").focus()},200)},this);this.modalInit(this.opts.curLang.image,this.opts.modal_image,610,callback)},imageEdit:function(image){var $el=image,parent=$el.parent().parent(),callback=$.proxy(function(){$("#redactor_file_alt").val($el.attr("alt")),$("#redactor_image_edit_src").attr("href",$el.attr("src")),$("#redactor_form_image_align").val($el.css("float")),"A"===$(parent).get(0).tagName&&($("#redactor_file_link").val($(parent).attr("href")),"_blank"==$(parent).attr("target")&&$("#redactor_link_blank").prop("checked",!0)),$("#redactor_image_delete_btn").click($.proxy(function(){this.imageRemove($el)},this)),$("#redactorSaveBtn").click($.proxy(function(){this.imageSave($el)},this))},this);this.modalInit(this.opts.curLang.image,this.opts.modal_image_edit,380,callback)},imageRemove:function(el){var parent=$(el).parent();$(el).remove(),parent.length&&"P"===parent[0].tagName&&(this.$editor.focus(),this.selectionStart(parent)),this.callback("imageDelete",el),this.modalClose(),this.sync()},imageSave:function(el){var $el=$(el),parent=$el.parent();$el.attr("alt",$("#redactor_file_alt").val());var floating=$("#redactor_form_image_align").val();if("left"===floating)$el.css({"float":"left",margin:"0 "+this.opts.imageFloatMargin+" "+this.opts.imageFloatMargin+" 0"});else if("right"===floating)$el.css({"float":"right",margin:"0 0 "+this.opts.imageFloatMargin+" "+this.opts.imageFloatMargin});else{var imageBox=$el.closest("#redactor-image-box");0!=imageBox.size()&&imageBox.css({"float":"",margin:""}),$el.css({"float":"",margin:""})}var link=$.trim($("#redactor_file_link").val());if(""!==link){var target=!1;if($("#redactor_link_blank").prop("checked")&&(target=!0),"A"!==parent.get(0).tagName){var a=$('<a href="'+link+'">'+this.outerHtml(el)+"</a>");
target&&a.attr("target","_blank"),$el.replaceWith(a)}else parent.attr("href",link),target?parent.attr("target","_blank"):parent.removeAttr("target")}else"A"===parent.get(0).tagName&&parent.replaceWith(this.outerHtml(el));this.modalClose(),this.observeImages(),this.sync()},imageResizeHide:function(e){if(e!==!1&&0!=$(e.target).parent().size()&&"redactor-image-box"===$(e.target).parent()[0].id)return!1;var imageBox=this.$editor.find("#redactor-image-box");if(0==imageBox.size())return!1;this.$editor.find("#redactor-image-editter, #redactor-image-resizer").remove();var margin=imageBox.css("margin");"0px"!=margin&&(imageBox.find("img").css("margin",margin),imageBox.css("margin","")),imageBox.find("img").css("opacity",""),imageBox.replaceWith(function(){return $(this).contents()}),$(document).off("click.redactor-image-resize-hide"),this.$editor.off("click.redactor-image-resize-hide"),this.$editor.off("keydown.redactor-image-delete"),this.sync()},imageResize:function(image){var $image=$(image);$image.on("mousedown",$.proxy(function(){this.imageResizeHide(!1)},this)),$image.on("dragstart",$.proxy(function(){this.$editor.on("drop.redactor-image-inside-drop",$.proxy(function(){setTimeout($.proxy(function(){this.observeImages(),this.$editor.off("drop.redactor-image-inside-drop"),this.sync()},this),1)},this))},this)),$image.on("click",$.proxy(function(e){if(0!=this.$editor.find("#redactor-image-box").size())return!1;var start_x,start_y,ratio=$image.width()/$image.height(),min_w=20,imageResizer=this.imageResizeControls($image),isResizing=!1;imageResizer.on("mousedown",function(e){isResizing=!0,e.preventDefault(),ratio=$image.width()/$image.height(),start_x=Math.round(e.pageX-$image.eq(0).offset().left),start_y=Math.round(e.pageY-$image.eq(0).offset().top)}),$(this.document.body).on("mousemove",$.proxy(function(e){if(isResizing){var mouse_y=(Math.round(e.pageX-$image.eq(0).offset().left)-start_x,Math.round(e.pageY-$image.eq(0).offset().top)-start_y),div_h=$image.height(),new_h=parseInt(div_h,10)+mouse_y,new_w=Math.round(new_h*ratio);new_w>min_w&&($image.width(new_w),100>new_w?this.imageEditter.css({marginTop:"-7px",marginLeft:"-13px",fontSize:"9px",padding:"3px 5px"}):this.imageEditter.css({marginTop:"-11px",marginLeft:"-18px",fontSize:"11px",padding:"7px 10px"})),start_x=Math.round(e.pageX-$image.eq(0).offset().left),start_y=Math.round(e.pageY-$image.eq(0).offset().top),this.sync()}},this)).on("mouseup",function(){isResizing=!1}),this.$editor.on("keydown.redactor-image-delete",$.proxy(function(e){var key=e.which;(this.keyCode.BACKSPACE==key||this.keyCode.DELETE==key)&&(this.imageResizeHide(!1),this.imageRemove($image))},this)),$(document).on("click.redactor-image-resize-hide",$.proxy(this.imageResizeHide,this)),this.$editor.on("click.redactor-image-resize-hide",$.proxy(this.imageResizeHide,this))},this))},imageResizeControls:function($image){var imageBox=$('<span id="redactor-image-box" data-redactor="verified">');imageBox.css({position:"relative",display:"inline-block",lineHeight:0,outline:"1px dashed rgba(0, 0, 0, .6)","float":$image.css("float")}),imageBox.attr("contenteditable",!1);var margin=$image.css("margin");"0px"!=margin&&(imageBox.css("margin",margin),$image.css("margin","")),$image.css("opacity",.5).after(imageBox),this.imageEditter=$('<span id="redactor-image-editter" data-redactor="verified">'+this.opts.curLang.edit+"</span>"),this.imageEditter.css({position:"absolute",zIndex:2,top:"50%",left:"50%",marginTop:"-11px",marginLeft:"-18px",lineHeight:1,backgroundColor:"#000",color:"#fff",fontSize:"11px",padding:"7px 10px",cursor:"pointer"}),this.imageEditter.attr("contenteditable",!1),this.imageEditter.on("click",$.proxy(function(){this.imageEdit($image)},this)),imageBox.append(this.imageEditter);var imageResizer=$('<span id="redactor-image-resizer" data-redactor="verified"></span>');return imageResizer.css({position:"absolute",zIndex:2,lineHeight:1,cursor:"nw-resize",bottom:"-4px",right:"-5px",border:"1px solid #fff",backgroundColor:"#000",width:"8px",height:"8px"}),imageResizer.attr("contenteditable",!1),imageBox.append(imageResizer),imageBox.append($image),imageResizer},imageThumbClick:function(e){var img='<img id="image-marker" src="'+$(e.target).attr("rel")+'" alt="'+$(e.target).attr("title")+'" />';this.opts.paragraphy&&(img="<p>"+img+"</p>"),this.imageInsert(img,!0)},imageCallbackLink:function(){var val=$("#redactor_file_link").val();if(""!==val){var data='<img id="image-marker" src="'+val+'" />';this.opts.linebreaks===!1&&(data="<p>"+data+"</p>"),this.imageInsert(data,!0)}else this.modalClose()},imageCallback:function(data){this.imageInsert(data)},imageInsert:function(json,link){if(this.selectionRestore(),json!==!1){var html="";link!==!0?(html='<img id="image-marker" src="'+json.filelink+'" />',this.opts.paragraphy&&(html="<p>"+html+"</p>")):html=json,this.execCommand("inserthtml",html,!1);var image=$(this.$editor.find("img#image-marker"));image.length?image.removeAttr("id"):image=!1,this.sync(),link!==!0&&this.callback("imageUpload",image,json)}this.modalClose(),this.observeImages()},modalTemplatesInit:function(){$.extend(this.opts,{modal_file:String()+'<section><div id="redactor-progress" class="redactor-progress redactor-progress-striped" style="display: none;"><div id="redactor-progress-bar" class="redactor-progress-bar" style="width: 100%;"></div></div><form id="redactorUploadFileForm" method="post" action="" enctype="multipart/form-data"><label>'+this.opts.curLang.filename+'</label><input type="text" id="redactor_filename" class="redactor_input" /><div style="margin-top: 7px;"><input type="file" id="redactor_file" name="file" /></div></form></section>',modal_image_edit:String()+"<section><label>"+this.opts.curLang.title+'</label><input id="redactor_file_alt" class="redactor_input" /><label>'+this.opts.curLang.link+'</label><input id="redactor_file_link" class="redactor_input" /><label><input type="checkbox" id="redactor_link_blank"> '+this.opts.curLang.link_new_tab+"</label><label>"+this.opts.curLang.image_position+'</label><select id="redactor_form_image_align"><option value="none">'+this.opts.curLang.none+'</option><option value="left">'+this.opts.curLang.left+'</option><option value="right">'+this.opts.curLang.right+'</option></select></section><footer><button id="redactor_image_delete_btn" class="redactor_modal_btn">'+this.opts.curLang._delete+'</button>&nbsp;&nbsp;&nbsp;<button class="redactor_modal_btn redactor_btn_modal_close">'+this.opts.curLang.cancel+'</button><input type="button" name="save" class="redactor_modal_btn" id="redactorSaveBtn" value="'+this.opts.curLang.save+'" /></footer>',modal_image:String()+'<section><div id="redactor_tabs"><a href="#" class="redactor_tabs_act">'+this.opts.curLang.upload+'</a><a href="#">'+this.opts.curLang.choose+'</a><a href="#">'+this.opts.curLang.link+'</a></div><div id="redactor-progress" class="redactor-progress redactor-progress-striped" style="display: none;"><div id="redactor-progress-bar" class="redactor-progress-bar" style="width: 100%;"></div></div><form id="redactorInsertImageForm" method="post" action="" enctype="multipart/form-data"><div id="redactor_tab1" class="redactor_tab"><input type="file" id="redactor_file" name="file" /></div><div id="redactor_tab2" class="redactor_tab" style="display: none;"><div id="redactor_image_box"></div></div></form><div id="redactor_tab3" class="redactor_tab" style="display: none;"><label>'+this.opts.curLang.image_web_link+'</label><input type="text" name="redactor_file_link" id="redactor_file_link" class="redactor_input"  /></div></section><footer><button class="redactor_modal_btn redactor_btn_modal_close">'+this.opts.curLang.cancel+'</button><input type="button" name="upload" class="redactor_modal_btn" id="redactor_upload_btn" value="'+this.opts.curLang.insert+'" /></footer>',modal_link:String()+'<section><form id="redactorInsertLinkForm" method="post" action=""><div id="redactor_tabs"><a href="#" class="redactor_tabs_act">URL</a><a href="#">Email</a><a href="#">'+this.opts.curLang.anchor+'</a></div><input type="hidden" id="redactor_tab_selected" value="1" /><div class="redactor_tab" id="redactor_tab1"><label>URL</label><input type="text" id="redactor_link_url" class="redactor_input"  /><label>'+this.opts.curLang.text+'</label><input type="text" class="redactor_input redactor_link_text" id="redactor_link_url_text" /><label><input type="checkbox" id="redactor_link_blank"> '+this.opts.curLang.link_new_tab+'</label></div><div class="redactor_tab" id="redactor_tab2" style="display: none;"><label>Email</label><input type="text" id="redactor_link_mailto" class="redactor_input" /><label>'+this.opts.curLang.text+'</label><input type="text" class="redactor_input redactor_link_text" id="redactor_link_mailto_text" /></div><div class="redactor_tab" id="redactor_tab3" style="display: none;"><label>'+this.opts.curLang.anchor+'</label><input type="text" class="redactor_input" id="redactor_link_anchor"  /><label>'+this.opts.curLang.text+'</label><input type="text" class="redactor_input redactor_link_text" id="redactor_link_anchor_text" /></div></form></section><footer><button class="redactor_modal_btn redactor_btn_modal_close">'+this.opts.curLang.cancel+'</button><input type="button" class="redactor_modal_btn" id="redactor_insert_link_btn" value="'+this.opts.curLang.insert+'" /></footer>',modal_table:String()+"<section><label>"+this.opts.curLang.rows+'</label><input type="text" size="5" value="2" id="redactor_table_rows" /><label>'+this.opts.curLang.columns+'</label><input type="text" size="5" value="3" id="redactor_table_columns" /></section><footer><button class="redactor_modal_btn redactor_btn_modal_close">'+this.opts.curLang.cancel+'</button><input type="button" name="upload" class="redactor_modal_btn" id="redactor_insert_table_btn" value="'+this.opts.curLang.insert+'" /></footer>',modal_video:String()+'<section><form id="redactorInsertVideoForm"><label>'+this.opts.curLang.video_html_code+'</label><textarea id="redactor_insert_video_area" style="width: 99%; height: 160px;"></textarea></form></section><footer><button class="redactor_modal_btn redactor_btn_modal_close">'+this.opts.curLang.cancel+'</button><input type="button" class="redactor_modal_btn" id="redactor_insert_video_btn" value="'+this.opts.curLang.insert+'" /></footer>'})},modalInit:function(title,content,width,callback){var $redactorModalOverlay=$("#redactor_modal_overlay");$redactorModalOverlay.length||(this.$overlay=$redactorModalOverlay=$('<div id="redactor_modal_overlay" style="display: none;"></div>'),$("body").prepend(this.$overlay)),this.opts.modalOverlay&&$redactorModalOverlay.show().on("click",$.proxy(this.modalClose,this));var $redactorModal=$("#redactor_modal");$redactorModal.length||(this.$modal=$redactorModal=$('<div id="redactor_modal" style="display: none;"><div id="redactor_modal_close">&times;</div><header id="redactor_modal_header"></header><div id="redactor_modal_inner"></div></div>'),$("body").append(this.$modal)),$("#redactor_modal_close").on("click",$.proxy(this.modalClose,this)),this.hdlModalClose=$.proxy(function(e){return e.keyCode===this.keyCode.ESC?(this.modalClose(),!1):void 0},this),$(document).keyup(this.hdlModalClose),this.$editor.keyup(this.hdlModalClose),this.modalcontent=!1,0==content.indexOf("#")?(this.modalcontent=$(content),$("#redactor_modal_inner").empty().append(this.modalcontent.html()),this.modalcontent.html("")):$("#redactor_modal_inner").empty().append(content),$redactorModal.find("#redactor_modal_header").html(title),"undefined"!=typeof $.fn.draggable&&($redactorModal.draggable({handle:"#redactor_modal_header"}),$redactorModal.find("#redactor_modal_header").css("cursor","move"));var $redactor_tabs=$("#redactor_tabs");if($redactor_tabs.length){var that=this;$redactor_tabs.find("a").each(function(i,s){i++,$(s).on("click",function(e){if(e.preventDefault(),$redactor_tabs.find("a").removeClass("redactor_tabs_act"),$(this).addClass("redactor_tabs_act"),$(".redactor_tab").hide(),$("#redactor_tab"+i).show(),$("#redactor_tab_selected").val(i),that.isMobile()===!1){var height=$redactorModal.outerHeight();$redactorModal.css("margin-top","-"+(height+10)/2+"px")}})})}$redactorModal.find(".redactor_btn_modal_close").on("click",$.proxy(this.modalClose,this)),this.opts.autoresize===!0&&(this.saveModalScroll=this.document.body.scrollTop),this.isMobile()===!1?($redactorModal.css({position:"fixed",top:"-2000px",left:"50%",width:width+"px",marginLeft:"-"+(width+60)/2+"px"}).show(),this.modalSaveBodyOveflow=$(document.body).css("overflow"),$(document.body).css("overflow","hidden")):$redactorModal.css({position:"fixed",width:"100%",height:"100%",top:"0",left:"0",margin:"0",minHeight:"300px"}).show(),"function"==typeof callback&&callback(),this.isMobile()===!1&&setTimeout(function(){var height=$redactorModal.outerHeight();$redactorModal.css({top:"50%",height:"auto",minHeight:"auto",marginTop:"-"+(height+10)/2+"px"})},10)},modalClose:function(){return $("#redactor_modal_close").off("click",this.modalClose),$("#redactor_modal").fadeOut("fast",$.proxy(function(){var redactorModalInner=$("#redactor_modal_inner");this.modalcontent!==!1&&(this.modalcontent.html(redactorModalInner.html()),this.modalcontent=!1),redactorModalInner.html(""),this.opts.modalOverlay&&$("#redactor_modal_overlay").hide().off("click",this.modalClose),$(document).unbind("keyup",this.hdlModalClose),this.$editor.unbind("keyup",this.hdlModalClose),this.selectionRestore(),this.opts.autoresize&&this.saveModalScroll&&$(this.document.body).scrollTop(this.saveModalScroll)},this)),this.isMobile()===!1&&$(document.body).css("overflow",this.modalSaveBodyOveflow?this.modalSaveBodyOveflow:"visible"),!1},modalSetTab:function(num){$(".redactor_tab").hide(),$("#redactor_tabs").find("a").removeClass("redactor_tabs_act").eq(num-1).addClass("redactor_tabs_act"),$("#redactor_tab"+num).show()},s3handleFileSelect:function(e){for(var f,files=e.target.files,i=0;f=files[i];i++)this.s3uploadFile(f)},s3uploadFile:function(file){this.s3executeOnSignedUrl(file,$.proxy(function(signedURL){this.s3uploadToS3(file,signedURL)},this))},s3executeOnSignedUrl:function(file,callback){var xhr=new XMLHttpRequest;xhr.open("GET",this.opts.s3+"?name="+file.name+"&type="+file.type,!0),xhr.overrideMimeType("text/plain; charset=x-user-defined"),xhr.onreadystatechange=function(e){4==this.readyState&&200==this.status?($("#redactor-progress").fadeIn(),callback(decodeURIComponent(this.responseText))):4==this.readyState&&200!=this.status},xhr.send()},s3createCORSRequest:function(method,url){var xhr=new XMLHttpRequest;return"withCredentials"in xhr?xhr.open(method,url,!0):"undefined"!=typeof XDomainRequest?(xhr=new XDomainRequest,xhr.open(method,url)):xhr=null,xhr},s3uploadToS3:function(file,url){var xhr=this.s3createCORSRequest("PUT",url);xhr&&(xhr.onload=$.proxy(function(){if(200==xhr.status){$("#redactor-progress").hide();var s3image=url.split("?");if(!s3image[0])return!1;this.selectionRestore();var html="";html='<img id="image-marker" src="'+s3image[0]+'" />',this.opts.paragraphy&&(html="<p>"+html+"</p>"),this.execCommand("inserthtml",html,!1);var image=$(this.$editor.find("img#image-marker"));image.length?image.removeAttr("id"):image=!1,this.sync(),this.callback("imageUpload",image,!1),this.modalClose(),this.observeImages()}},this),xhr.onerror=function(){},xhr.upload.onprogress=function(e){},xhr.setRequestHeader("Content-Type",file.type),xhr.setRequestHeader("x-amz-acl","public-read"),xhr.send(file))},uploadInit:function(el,options){this.uploadOptions={url:!1,success:!1,error:!1,start:!1,trigger:!1,auto:!1,input:!1},$.extend(this.uploadOptions,options);var $el=$("#"+el);$el.length&&"INPUT"===$el[0].tagName?(this.uploadOptions.input=$el,this.el=$($el[0].form)):this.el=$el,this.element_action=this.el.attr("action"),this.uploadOptions.auto?$(this.uploadOptions.input).change($.proxy(function(e){this.el.submit(function(e){return!1}),this.uploadSubmit(e)},this)):this.uploadOptions.trigger&&$("#"+this.uploadOptions.trigger).click($.proxy(this.uploadSubmit,this))},uploadSubmit:function(e){$("#redactor-progress").fadeIn(),this.uploadForm(this.element,this.uploadFrame())},uploadFrame:function(){this.id="f"+Math.floor(99999*Math.random());var d=this.document.createElement("div"),iframe='<iframe style="display:none" id="'+this.id+'" name="'+this.id+'"></iframe>';return d.innerHTML=iframe,$(d).appendTo("body"),this.uploadOptions.start&&this.uploadOptions.start(),$("#"+this.id).load($.proxy(this.uploadLoaded,this)),this.id},uploadForm:function(f,name){if(this.uploadOptions.input){var formId="redactorUploadForm"+this.id,fileId="redactorUploadFile"+this.id;this.form=$('<form  action="'+this.uploadOptions.url+'" method="POST" target="'+name+'" name="'+formId+'" id="'+formId+'" enctype="multipart/form-data" />'),this.opts.uploadFields!==!1&&"object"==typeof this.opts.uploadFields&&$.each(this.opts.uploadFields,$.proxy(function(k,v){null!=v&&0===v.toString().indexOf("#")&&(v=$(v).val());var hidden=$("<input/>",{type:"hidden",name:k,value:v});$(this.form).append(hidden)},this));var oldElement=this.uploadOptions.input,newElement=$(oldElement).clone();$(oldElement).attr("id",fileId).before(newElement).appendTo(this.form),$(this.form).css("position","absolute").css("top","-2000px").css("left","-2000px").appendTo("body"),this.form.submit()}else f.attr("target",name).attr("method","POST").attr("enctype","multipart/form-data").attr("action",this.uploadOptions.url),this.element.submit()},uploadLoaded:function(){var d,i=$("#"+this.id)[0];if(d=i.contentDocument?i.contentDocument:i.contentWindow?i.contentWindow.document:window.frames[this.id].document,this.uploadOptions.success)if($("#redactor-progress").hide(),"undefined"!=typeof d){var rawString=d.body.innerHTML,jsonString=rawString.match(/\{(.|\n)*\}/)[0];jsonString=jsonString.replace(/^\[/,""),jsonString=jsonString.replace(/\]$/,"");var json=$.parseJSON(jsonString);"undefined"==typeof json.error?this.uploadOptions.success(json):(this.uploadOptions.error(this,json),this.modalClose())}else this.modalClose(),alert("Upload failed!");this.el.attr("action",this.element_action),this.el.attr("target","")},draguploadInit:function(el,options){return this.draguploadOptions=$.extend({url:!1,success:!1,error:!1,preview:!1,uploadFields:!1,text:this.opts.curLang.drop_file_here,atext:this.opts.curLang.or_choose},options),void 0===window.FormData?!1:(this.droparea=$('<div class="redactor_droparea"></div>'),this.dropareabox=$('<div class="redactor_dropareabox">'+this.draguploadOptions.text+"</div>"),this.dropalternative=$('<div class="redactor_dropalternative">'+this.draguploadOptions.atext+"</div>"),this.droparea.append(this.dropareabox),$(el).before(this.droparea),$(el).before(this.dropalternative),this.dropareabox.on("dragover",$.proxy(function(){return this.draguploadOndrag()},this)),this.dropareabox.on("dragleave",$.proxy(function(){return this.draguploadOndragleave()},this)),void(this.dropareabox.get(0).ondrop=$.proxy(function(e){e.preventDefault(),this.dropareabox.removeClass("hover").addClass("drop"),this.dragUploadAjax(this.draguploadOptions.url,e.dataTransfer.files[0],!1)},this)))},dragUploadAjax:function(url,file,directupload,progress,e){if(!directupload){var xhr=$.ajaxSettings.xhr();xhr.upload&&xhr.upload.addEventListener("progress",$.proxy(this.uploadProgress,this),!1),$.ajaxSetup({xhr:function(){return xhr}})}var fd=new FormData;fd.append("file",file),this.opts.uploadFields!==!1&&"object"==typeof this.opts.uploadFields&&$.each(this.opts.uploadFields,$.proxy(function(k,v){null!=v&&0===v.toString().indexOf("#")&&(v=$(v).val()),fd.append(k,v)},this)),$.ajax({url:url,dataType:"html",data:fd,cache:!1,contentType:!1,processData:!1,type:"POST",success:$.proxy(function(data){data=data.replace(/^\[/,""),data=data.replace(/\]$/,"");var json=$.parseJSON(data);if(directupload){progress.fadeOut("slow",function(){$(this).remove()});var $img=$("<img>");$img.attr("src",json.filelink).attr("id","drag-image-marker"),this.insertNodeToCaretPositionFromPoint(e,$img[0]);var image=$(this.$editor.find("img#drag-image-marker"));image.length?image.removeAttr("id"):image=!1,this.sync(),this.observeImages(),image&&this.callback("imageUpload",image,json),"undefined"!=typeof json.error&&this.callback("imageUploadError",json)}else"undefined"==typeof json.error?this.draguploadOptions.success(json):(this.draguploadOptions.error(this,json),this.draguploadOptions.success(!1))},this)})},draguploadOndrag:function(){return this.dropareabox.addClass("hover"),!1},draguploadOndragleave:function(){return this.dropareabox.removeClass("hover"),!1},uploadProgress:function(e,text){var percent=e.loaded?parseInt(e.loaded/e.total*100,10):e;this.dropareabox.text("Loading "+percent+"% "+(text||""))},isMobile:function(){return/(iPhone|iPod|BlackBerry|Android)/.test(navigator.userAgent)},normalize:function(str){return"undefined"==typeof str?0:parseInt(str.replace("px",""),10)},outerHtml:function(el){return $("<div>").append($(el).eq(0).clone()).html()},isString:function(obj){return"[object String]"==Object.prototype.toString.call(obj)},isEmpty:function(html){return html=html.replace(/&#x200b;|<br>|<br\/>|&nbsp;/gi,""),html=html.replace(/\s/g,""),html=html.replace(/^<p>[^\W\w\D\d]*?<\/p>$/i,""),""==html},browser:function(browser){var ua=navigator.userAgent.toLowerCase(),match=/(chrome)[ \/]([\w.]+)/.exec(ua)||/(webkit)[ \/]([\w.]+)/.exec(ua)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(ua)||/(msie) ([\w.]+)/.exec(ua)||ua.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(ua)||[];return"version"==browser?match[2]:"webkit"==browser?"chrome"==match[1]||"webkit"==match[1]:match[1]==browser},oldIE:function(){return this.browser("msie")&&parseInt(this.browser("version"),10)<9?!0:!1},getFragmentHtml:function(fragment){var cloned=fragment.cloneNode(!0),div=this.document.createElement("div");return div.appendChild(cloned),div.innerHTML},extractContent:function(){for(var child,node=this.$editor[0],frag=this.document.createDocumentFragment();child=node.firstChild;)frag.appendChild(child);return frag},isParentRedactor:function(el){return el?this.opts.iframe?el:0==$(el).parents("div.redactor_editor").length||$(el).hasClass("redactor_editor")?!1:el:!1},currentOrParentIs:function(tagName){var parent=this.getParent(),current=this.getCurrent();return parent&&parent.tagName===tagName?parent:current&&current.tagName===tagName?current:!1},isEndOfElement:function(){var current=this.getBlock(),offset=this.getCaretOffset(current),text=$.trim($(current).text()).replace(/\n\r\n/g,""),len=text.length;return offset==len?!0:!1},isFocused:function(){var el,sel=this.getSelection();return sel&&sel.rangeCount&&sel.rangeCount>0&&(el=sel.getRangeAt(0).startContainer),el?this.opts.iframe?this.getCaretOffsetRange().equals()?!this.$editor.is(el):!0:0!=$(el).closest("div.redactor_editor").length:!1},removeEmptyAttr:function(el,attr){""==$(el).attr(attr)&&$(el).removeAttr(attr)},removeFromArrayByValue:function(array,value){for(var index=null;-1!==(index=array.indexOf(value));)array.splice(index,1);return array}},Redactor.prototype.init.prototype=Redactor.prototype,$.Redactor.fn.formatLinkify=function(protocol,convertLinks,convertImageLinks,convertVideoLinks){for(var url1=/(^|&lt;|\s)(www\..+?\..+?)(\s|&gt;|$)/g,url2=/(^|&lt;|\s)(((https?|ftp):\/\/|mailto:).+?)(\s|&gt;|$)/g,urlImage=/(https?:\/\/.*\.(?:png|jpg|jpeg|gif))/gi,urlYoutube=/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/,urlVimeo=/http:\/\/(www\.)?vimeo.com\/(\d+)($|\/)/,childNodes=(this.$editor?this.$editor.get(0):this).childNodes,i=childNodes.length;i--;){var n=childNodes[i];if(3===n.nodeType){var html=n.nodeValue;if(convertVideoLinks&&html){var iframeStart='<iframe width="500" height="281" src="',iframeEnd='" frameborder="0" allowfullscreen></iframe>';html.match(urlYoutube)?(html=html.replace(urlYoutube,iframeStart+"//www.youtube.com/embed/$2"+iframeEnd),$(n).after(html).remove()):html.match(urlVimeo)&&(html=html.replace(urlVimeo,iframeStart+"//player.vimeo.com/video/$2"+iframeEnd),$(n).after(html).remove())}if(convertImageLinks&&html&&html.match(urlImage)&&(html=html.replace(urlImage,'<img src="$1">'),$(n).after(html).remove()),convertLinks&&html&&(html.match(url1)||html.match(url2))){var href=html.match(url1)||html.match(url2);href=href[0],href.length>50&&(href=href.substring(0,50)+"..."),html=html.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(url1,'$1<a href="'+protocol+'$2">'+href+"</a>$3").replace(url2,'$1<a href="$2">'+href+"</a>$5"),$(n).after(html).remove()}}else 1!==n.nodeType||/^(a|button|textarea)$/i.test(n.tagName)||$.Redactor.fn.formatLinkify.call(n,protocol,convertLinks,convertImageLinks,convertVideoLinks)}}}(jQuery);
!function(){"use strict";function trust($sce){return function(text){return $sce.trustAsHtml(text)}}angular.module("app").filter("trust",trust),trust.$inject=["$sce"]}();
!function(){"use strict";function numberLength(){return function(a,b){return(1e4+a+"").slice(-b)}}angular.module("app").filter("numberLength",numberLength)}();
!function(){"use strict";function Routes($stateProvider,$urlRouterProvider){$urlRouterProvider.when("/t?id","/topic/:id").otherwise(function($injector){var $state=$injector.get("$state");$state.go("blog")}),$stateProvider.state({name:"blog",url:"/blog",views:{main:{templateUrl:"app/views/blog/blog.html",controller:"BlogController",controllerAs:"vm"}},data:{permissions:{except:["syndicated","member","admin"],redirectTo:"login"}}}).state({name:"login",url:"/login",views:{main:{templateUrl:"app/views/login/login.html",controller:"LoginController",controllerAs:"vm"}},data:{permissions:{except:["guest","member","admin"],redirectTo:"forum"}}}).state({name:"admin",url:"/admin",views:{main:{templateUrl:"app/views/admin/admin.html",controller:"AdminController",controllerAs:"vm"}},data:{permissions:{only:["admin"],redirectTo:"forum"}}}).state({name:"forum",url:"/forum",views:{main:{templateUrl:"app/views/forum/forum.html",controller:"ForumController",controllerAs:"vm"}},data:{permissions:{only:["member"],redirectTo:"blog"}}}).state({name:"topic",url:"/topic/:id",views:{main:{templateUrl:"app/views/forum/topic.html",controller:"TopicController",controllerAs:"vm"}},data:{permissions:{only:["member"],redirectTo:"login"}}})}angular.module("app").config(Routes),Routes.$inject=["$stateProvider","$urlRouterProvider"]}();
!function(){"use strict";function DefinePermissions($q,$localForage,Permission){Permission.defineRole("guest",function(){var deferred=$q.defer();return $localForage.getItem("currentUser").then(function(res){return res&&deferred.reject(),$localForage.getItem("syndicated")}).then(function(res){res?deferred.reject():deferred.resolve()}),deferred.promise}).defineRole("syndicated",function(){var deferred=$q.defer();return $localForage.getItem("syndicated").then(function(res){res?deferred.resolve():deferred.reject()}),deferred.promise}).defineRole("member",function(){var deferred=$q.defer();return $localForage.getItem("currentUser").then(function(res){res?deferred.resolve():deferred.reject()}),deferred.promise}).defineRole("admin",function(){var deferred=$q.defer();return $localForage.getItem("currentUser").then(function(res){res&&(res.isAdmin||res.isSuperAdmin)?deferred.resolve():deferred.reject()}),deferred.promise})}angular.module("app").run(DefinePermissions),DefinePermissions.$inject=["$q","$localForage","Permission"]}();
!function(){"use strict";function AppController($rootScope,$localForage,Member,LoopBackAuth){function saveCurrentUser(user){user?($localForage.setItem("currentUser",user),$rootScope.currentUser=user):removeUser()}function removeUser(){$localForage.removeItem("currentUser"),$rootScope.currentUser=!1,LoopBackAuth.currentUserId&&(LoopBackAuth.clearUser(),LoopBackAuth.clearStorage())}Member.getCurrent().$promise.then(saveCurrentUser)["catch"](removeUser)}angular.module("app").controller("AppController",AppController),AppController.$inject=["$rootScope","$localForage","Member","LoopBackAuth"]}();